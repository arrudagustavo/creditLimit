<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Limite de Crédito</title>
    <!-- Carregamento do Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos para responsividade da tabela em telas pequenas */
        @media screen and (max-width: 768px) {
            .responsive-table thead { display: none; }
            .responsive-table tr { display: block; margin-bottom: 1rem; border-bottom: 2px solid #ddd; }
            .responsive-table td { display: block; text-align: right; padding-left: 50%; position: relative; }
            .responsive-table td::before { content: attr(data-label); position: absolute; left: 0.5rem; width: 45%; padding-right: 0.5rem; text-align: left; font-weight: bold; }
        }
        .asterisk { color: #ef4444; }
        /* Força a cor do texto em selects desabilitados para corresponder aos inputs */
        select:disabled {
            color: #6b7280; /* Cor de texto cinza-500 do Tailwind */
        }
        /* Garante que a modal de confirmação fique sobre as outras */
        .z-60 {
            z-index: 60;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Tela de Login -->
    <div id="loginScreen" class="container mx-auto flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Login</h1>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required placeholder="seu@email.com">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required placeholder="********">
                </div>
                <button type="submit" id="loginButton" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 shadow-sm flex items-center justify-center">
                    <span id="loginButtonText">Entrar</span>
                    <!-- Spinner de carregamento -->
                    <svg id="loginSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <!-- Aplicação Principal (escondida até o login) -->
    <div id="app" class="container mx-auto p-4 md:p-8 hidden">
        
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Gerenciamento de Limite</h1>
                <p class="text-gray-500">Busque um cliente para visualizar ou cadastrar limites.</p>
            </div>
            <div id="userInfo" class="text-right">
                <p class="text-sm text-gray-700">Bem-vindo(a), <strong id="userEmailDisplay"></strong></p>
                <button id="logoutButton" class="text-sm text-red-600 hover:underline">Sair</button>
            </div>
        </header>

        <main class="bg-white p-6 rounded-lg shadow-md">
            <!-- Barra de busca e botões de ação -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div class="relative w-full md:w-1/3">
                    <input type="text" id="searchInput" placeholder="Buscar por Documento (CNPJ/CPF)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                    <button id="searchButton" class="absolute right-0 top-0 mt-3 mr-4 text-gray-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </button>
                </div>
                <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                    <!-- Botão de Relatório sempre ativo -->
                    <button id="extractReportButton" class="w-full md:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition duration-300 shadow-sm">
                        Extrair Relatório
                    </button>
                    <!-- Botões desabilitados por padrão, ativados após encontrar o cliente -->
                    <button id="addTypeButton" class="w-full md:w-auto bg-gray-400 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-sm cursor-not-allowed" disabled>
                        + Novo Tipo
                    </button>
                    <button id="addLimitButton" class="w-full md:w-auto bg-gray-400 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-sm cursor-not-allowed" disabled>
                        + Novo Limite
                    </button>
                </div>
            </div>

            <!-- Seção de Informações do Cliente (Aparece após busca bem-sucedida) -->
            <div id="customerInfoSection" class="bg-blue-50 p-4 border border-blue-200 rounded-lg mb-6 hidden">
                <h2 class="text-xl font-bold text-blue-800 mb-4">Informações do Cliente</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-700">
                    <div><span class="font-semibold">Nome:</span> <span id="customerName"></span></div>
                    <div><span class="font-semibold">Documento:</span> <span id="customerDocument"></span></div>
                    <div><span class="font-semibold">Email:</span> <span id="customerEmail"></span></div>
                    <div><span class="font-semibold">Telefone:</span> <span id="customerPhone"></span></div>
                    <div><span class="font-semibold">Contato:</span> <span id="customerContactName"></span></div>
                    <div class="md:col-span-2"><span class="font-semibold">Endereço:</span> <span id="customerAddress"></span></div>
                </div>
            </div>

            <!-- Mensagem de estado inicial ou não encontrado -->
            <div id="initialStateMessage" class="text-center p-8 text-gray-500">
                Utilize a busca acima para encontrar um cliente pelo CPF/CNPJ.
            </div>

            <!-- Tabela de Limites de Crédito (Título dinâmico) -->
            <h2 id="limitsTableTitle" class="text-xl font-bold text-gray-800 mb-4 mt-6 hidden">Limites de Crédito Cadastrados</h2>
            
            <div class="overflow-x-auto" id="limitsTableContainer" >
                <table class="min-w-full bg-white responsive-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <!-- COLUNA DOCUMENTO REMOVIDA AQUI -->
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor (R$)</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo (R$)</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ativo</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Sem Limite Além Saldo</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Última Alteração</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="creditLimitTableBody" class="divide-y divide-gray-200">
                         <tr><td colspan="7" class="text-center p-8 text-gray-500">Nenhum limite de crédito encontrado.</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Modal de Adicionar/Editar Limite -->
    <div id="formModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-800">Adicionar Novo Limite</h2>
                <button id="closeModalButton" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <form id="creditLimitForm">
                <input type="hidden" id="isEditing" value="">

                <div class="mb-4">
                    <label for="documento" class="block text-sm font-medium text-gray-700 mb-1">Documento (CNPJ/CPF) <span class="asterisk">*</span></label>
                    <input type="text" id="documento" name="document" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="(somente números)" required>
                </div>

                <div class="mb-4">
                    <label for="tipo" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Limite <span class="asterisk">*</span></label>
                    <select id="tipo" name="credit_type" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="" disabled selected>Selecione um tipo...</option>
                        <!-- Opções são adicionadas via JS, mas mantidas as de exemplo para consistência do código original -->
                        <option value="NCAVISTA">NCAVISTA</option>
                        <option value="NCAPRAZO">NCAPRAZO</option>
                        <option value="LIMITELEO">LIMITELEO</option>
                        <option value="AVISTA2">AVISTA2</option>
                        <option value="TESTEAPI">TESTEAPI</option>
                    </select>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="valor" class="block text-sm font-medium text-gray-700 mb-1">Valor do Limite (R$) <span class="asterisk">*</span></label>
                        <input type="text" id="valor" name="value" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="0,00">
                    </div>
                    <div>
                        <label for="saldo" class="block text-sm font-medium text-gray-700 mb-1">Saldo Disponível (R$)</label>
                        <input type="text" id="saldo" name="balance" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0,00">
                    </div>
                </div>

                <div class="flex items-center space-x-8 mb-6">
                    <div class="flex items-center">
                        <input type="checkbox" id="ativo" name="active" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="ativo" class="ml-2 block text-sm text-gray-900">Ativo</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="semLimite" name="without_credit_limit" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="semLimite" class="ml-2 block text-sm text-gray-900">Sem Limite Além do Saldo</label>
                    </div>
                </div>

                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelButton" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" id="saveLimitButton" class="bg-gray-400 text-white font-bold py-2 px-6 rounded-lg transition cursor-not-allowed" disabled>Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Adicionar Novo Tipo de Limite -->
    <div id="typeFormModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 id="typeModalTitle" class="text-2xl font-bold text-gray-800">Adicionar Novo Tipo de Limite</h2>
                <button id="closeTypeModalButton" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <form id="creditTypeForm">
                <div class="mb-4">
                    <label for="typeName" class="block text-sm font-medium text-gray-700 mb-1">Nome do Tipo <span class="asterisk">*</span></label>
                    <input type="text" id="typeName" name="name" placeholder="Ex: PRAZO 90D" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="typeCode" class="block text-sm font-medium text-gray-700 mb-1">Código do Tipo <span class="asterisk">*</span></label>
                    <input type="text" id="typeCode" name="code" placeholder="Ex: PRAZO_90D (sem espaços)" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancelTypeButton" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" id="saveTypeButton" class="bg-gray-400 text-white font-bold py-2 px-6 rounded-lg transition cursor-not-allowed" disabled>Salvar Tipo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão (Desativação) -->
    <div id="deleteConfirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Confirmar Exclusão</h2>
            <p class="text-gray-600 mb-6">Você tem certeza que deseja excluir (desativar) o limite de crédito para o documento <strong id="documentToDelete" class="text-gray-900"></strong> - <strong id="typeToDelete" class="text-gray-900"></strong>?</p>
            <div class="flex justify-end gap-4">
                <button id="cancelDeleteButton" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                <button id="confirmDeleteButton" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition">Confirmar Exclusão</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Extração do Relatório (Todos os limites) -->
    <div id="reportConfirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-60 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Confirmar Extração</h2>
            <p class="text-gray-600 mb-6">Nenhum registro foi encontrado no período e/ou filtro selecionado(s). Deseja extrair um relatório com **todos** os limites disponíveis?</p>
            <div class="flex justify-end gap-4">
                <button id="cancelReportConfirmButton" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                <button id="confirmReportButton" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition">Sim, Extrair Todos</button>
            </div>
        </div>
    </div>

    <!-- Modal de Geração de Relatório -->
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Extrair Relatório de Limites</h2>
                <button id="closeReportModalButton" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <form id="reportForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Data de Início</label>
                        <input type="date" id="startDate" name="startDate" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">Data de Fim</label>
                        <input type="date" id="endDate" name="endDate" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="reportLimitType" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Tipo de Limite</label>
                    <select id="reportLimitType" name="reportLimitType" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="" selected>Todos os Tipos</option>
                        <!-- Opções são preenchidas dinamicamente pelo JS -->
                    </select>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelReportButton" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button type="submit" id="generateReportButton" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition">Gerar Relatório</button>
                </div>
            </form>
            <!-- Resultado do relatório -->
            <div id="reportResult" class="mt-6 border-t pt-4 hidden">
                 </div>
        </div>
    </div>

    <!-- Notificações de Sucesso/Erro -->
    <div id="notification" class="fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg transition-opacity duration-300 opacity-0 hidden">
        <p id="notificationMessage"></p>
    </div>

    <!-- Modal de Alerta/Aviso -->
    <div id="warningModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold text-yellow-600 mb-4">Atenção</h2>
            <p id="warningMessage" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end">
                <button id="closeWarningModalButton" class="bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-600 transition">Fechar</button>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- CONFIGURAÇÕES E VARIÁVEIS GLOBAIS ---
    // URL da API de sandbox
    const API_BASE_URL = 'https://ws.sandbox.autorei.net'; 
    let BEARER_TOKEN = ''; // Preenchido após o login
    let LOGGED_IN_USER_EMAIL = ''; // Preenchido após o login

    let currentLimits = [];
    let deletePayload = null;
    let allLimitsForReport = [];
    let foundCustomerDocument = null; // Armazena o documento do cliente encontrado

    // --- ELEMENTOS DO DOM (TELA PRINCIPAL) ---
    const appScreen = document.getElementById('app');
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const tableBody = document.getElementById('creditLimitTableBody');
    const addLimitButton = document.getElementById('addLimitButton');
    const addTypeButton = document.getElementById('addTypeButton');
    const userEmailDisplay = document.getElementById('userEmailDisplay');
    const logoutButton = document.getElementById('logoutButton');
    const extractReportButton = document.getElementById('extractReportButton');
    
    // Novos Elementos para a UI do Cliente
    const customerInfoSection = document.getElementById('customerInfoSection');
    const initialStateMessage = document.getElementById('initialStateMessage');
    const limitsTableTitle = document.getElementById('limitsTableTitle');
    const limitsTableContainer = document.getElementById('limitsTableContainer');

    const customerNameSpan = document.getElementById('customerName');
    const customerDocumentSpan = document.getElementById('customerDocument');
    const customerEmailSpan = document.getElementById('customerEmail');
    const customerPhoneSpan = document.getElementById('customerPhone');
    const customerContactNameSpan = document.getElementById('customerContactName');
    const customerAddressSpan = document.getElementById('customerAddress');

    // --- ELEMENTOS DO DOM (LOGIN) ---
    const loginScreen = document.getElementById('loginScreen');
    const loginForm = document.getElementById('loginForm');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('loginButton');
    const loginButtonText = document.getElementById('loginButtonText');
    const loginSpinner = document.getElementById('loginSpinner');
    
    // --- ELEMENTOS DO DOM (MODAIS) ---
    const formModal = document.getElementById('formModal');
    const modalTitle = document.getElementById('modalTitle');
    const closeModalButton = document.getElementById('closeModalButton');
    const cancelButton = document.getElementById('cancelButton');
    const creditLimitForm = document.getElementById('creditLimitForm');
    const saveLimitButton = document.getElementById('saveLimitButton');
    const isEditingInput = document.getElementById('isEditing');
    const documentoInput = document.getElementById('documento');
    const tipoSelect = document.getElementById('tipo');
    const valorInput = document.getElementById('valor');
    const saldoInput = document.getElementById('saldo');

    const typeFormModal = document.getElementById('typeFormModal');
    const closeTypeModalButton = document.getElementById('closeTypeModalButton');
    const cancelTypeButton = document.getElementById('cancelTypeButton');
    const creditTypeForm = document.getElementById('creditTypeForm');
    const typeNameInput = document.getElementById('typeName');
    const typeCodeInput = document.getElementById('typeCode');
    const saveTypeButton = document.getElementById('saveTypeButton');

    const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
    const documentToDeleteSpan = document.getElementById('documentToDelete');
    const typeToDeleteSpan = document.getElementById('typeToDelete');
    const cancelDeleteButton = document.getElementById('cancelDeleteButton');
    const confirmDeleteButton = document.getElementById('confirmDeleteButton');

    const reportConfirmationModal = document.getElementById('reportConfirmationModal');
    const cancelReportConfirmButton = document.getElementById('cancelReportConfirmButton');
    const confirmReportButton = document.getElementById('confirmReportButton');

    const reportModal = document.getElementById('reportModal');
    const closeReportModalButton = document.getElementById('closeReportModalButton');
    const cancelReportButton = document.getElementById('cancelReportButton');
    const reportForm = document.getElementById('reportForm');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const reportResultDiv = document.getElementById('reportResult');
    const reportLimitTypeSelect = document.getElementById('reportLimitType');
    
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notificationMessage');
    
    const warningModal = document.getElementById('warningModal');
    const warningMessage = document.getElementById('warningMessage');
    const closeWarningModalButton = document.getElementById('closeWarningModalButton');

    // --- FUNÇÕES DE LOGIN/LOGOUT ---
    
    // Mostra/Esconde o spinner no botão de login
    function showLoginSpinner(show) {
        if (show) {
            loginButtonText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');
            loginButton.disabled = true;
        } else {
            loginButtonText.classList.remove('hidden');
            loginSpinner.classList.add('hidden');
            loginButton.disabled = false;
        }
    }

    // Gerencia a submissão do formulário de login
    async function handleLogin(e) {
        e.preventDefault();
        showLoginSpinner(true);
        const email = emailInput.value;
        const password = passwordInput.value;

        const loginApiUrl = `${API_BASE_URL}/oauth/token`;
        const params = new URLSearchParams();
        params.append('scope', 'trust');
        params.append('grant_type', 'password');
        params.append('username', email);
        params.append('password', password);

        try {
            const response = await fetch(loginApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    // Credenciais Basic Auth codificadas
                    'Authorization': 'Basic YXBpLXdzOnBhc3N3b3JkLW1hc3Rlcg==' 
                },
                body: params
            });

            if (!response.ok) {
                // Tenta ler a mensagem de erro da API, se disponível
                const errorBody = await response.json().catch(() => ({}));
                throw new Error(errorBody.error_description || 'Email ou senha inválidos.');
            }

            const data = await response.json();
            BEARER_TOKEN = data.access_token;
            LOGGED_IN_USER_EMAIL = email;
            
            // Armazena a sessão no localStorage
            localStorage.setItem('bearerToken', BEARER_TOKEN);
            localStorage.setItem('loggedInUserEmail', LOGGED_IN_USER_EMAIL);

            userEmailDisplay.textContent = email;
            loginScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            
            resetAppView(); // Redefine o estado da aplicação para a visualização de busca

        } catch (error) {
            console.error('Falha no login:', error);
            showNotification(error.message, 'error');
        } finally {
            showLoginSpinner(false);
        }
    }

    // Gerencia o logout
    function handleLogout() {
        BEARER_TOKEN = '';
        LOGGED_IN_USER_EMAIL = '';
        emailInput.value = '';
        passwordInput.value = '';

        // Limpa a sessão do localStorage
        localStorage.removeItem('bearerToken');
        localStorage.removeItem('loggedInUserEmail');
        
        appScreen.classList.add('hidden');
        loginScreen.classList.remove('hidden');
    }

    // --- FUNÇÕES DE LÓGICA E UI DA APLICAÇÃO ---

    function resetAppView() {
        // Limpa e esconde as informações do cliente
        customerInfoSection.classList.add('hidden');
        customerNameSpan.textContent = '';
        customerDocumentSpan.textContent = '';
        customerEmailSpan.textContent = '';
        customerPhoneSpan.textContent = '';
        customerContactNameSpan.textContent = '';
        customerAddressSpan.textContent = '';

        // Mostra a mensagem de estado inicial
        initialStateMessage.innerHTML = 'Utilize a busca acima para encontrar um cliente pelo CPF/CNPJ.';
        initialStateMessage.classList.remove('hidden');
        initialStateMessage.classList.remove('text-red-600');
        
        // Limpa a tabela de limites e esconde o título
        // Ajusta colspan para 7 (era 8 antes da remoção da coluna Documento)
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">Nenhum limite de crédito encontrado.</td></tr>';
        limitsTableTitle.classList.add('hidden');
        limitsTableContainer.classList.add('hidden');

        // Desabilita botões
        toggleActionButtons(false);
        foundCustomerDocument = null;
    }

    function toggleActionButtons(enabled) {
        const buttons = [addLimitButton, addTypeButton];
        const baseClasses = 'w-full md:w-auto text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-sm';
        
        buttons.forEach(btn => {
            btn.disabled = !enabled;
            btn.className = baseClasses;
            if (enabled) {
                btn.classList.add(btn.id === 'addLimitButton' ? 'bg-blue-600' : 'bg-gray-600');
                btn.classList.add(btn.id === 'addLimitButton' ? 'hover:bg-blue-700' : 'hover:bg-gray-700');
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            } else {
                btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-gray-600', 'hover:bg-gray-700');
            }
        });
    }

    // --- FUNÇÕES DE LOG ---
    // Simula o log de ações (apenas no console)
    function logChange(action, document, details = {}) {
        const timestamp = new Date().toLocaleString('pt-BR');
        const logEntry = {
            user: LOGGED_IN_USER_EMAIL,
            action,
            clientDocument: document,
            details,
            timestamp
        };
        console.log('LOG:', logEntry);
    }

    // --- FUNÇÕES DE API ---
    
    // Busca dados do Cliente na API /customer
    async function fetchCustomer(document) {
        const cleanDoc = document.replace(/\D/g, '');
        const url = `${API_BASE_URL}/customer/${cleanDoc}/document`;
        
        try {
            const response = await fetch(url, { headers: { 'Authorization': `Bearer ${BEARER_TOKEN}` } });
            
            if (response.status === 404) {
                 // Cliente não encontrado - Retorna uma mensagem de erro específica
                throw new Error(`O documento ${formatDocument(document)} não foi encontrado na base de clientes.`);
            }
            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({}));
                throw new Error(errorBody.message || `Erro ao buscar cliente: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // CORREÇÃO: Acessa o objeto aninhado 'customer'
            const customerData = data.customer || data; 
            
            return { success: true, data: customerData };
        } catch (error) {
            console.error('Falha ao buscar cliente:', error);
            return { success: false, error: error.message };
        }
    }
    
    // Busca limites de crédito na API /creditLimit
    async function fetchCreditLimits(document = '') {
        const url = new URL(`${API_BASE_URL}/creditLimit/list`);
        url.searchParams.append('limit', '25'); // Limite padrão de 25
        if (document) url.searchParams.append('document', document.replace(/\D/g, ''));

        try {
            const response = await fetch(url, { headers: { 'Authorization': `Bearer ${BEARER_TOKEN}`, 'Content-Type': 'application/json' } });
            if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
            const data = await response.json();
            return { success: true, data };
        } catch (error) {
            console.error('Falha ao buscar limites:', error);
            showNotification(`Erro ao buscar limites: ${error.message}`, 'error');
            return { success: false, data: [] };
        }
    }

    // Salva ou atualiza um limite de crédito
    async function saveCreditLimit(limitData) {
        const isEditing = !!isEditingInput.value;
        
        try {
            const response = await fetch(`${API_BASE_URL}/creditLimit/save`, { 
                method: 'POST', 
                headers: { 
                    'Authorization': `Bearer ${BEARER_TOKEN}`, 
                    'Content-Type': 'application/json' 
                }, 
                body: JSON.stringify(limitData) 
            });
            
            if (!response.ok) {
                 const errorBody = await response.json().catch(() => ({}));
                 throw new Error(errorBody.message || `Erro na API: ${response.statusText}`);
            }
            const data = await response.json();
            logChange(isEditing ? 'ATUALIZOU LIMITE' : 'CRIOU LIMITE', data.document, { newValues: data });
            return { success: true, data };
        } catch (error) {
            console.error('Falha ao salvar limite:', error);
            showNotification(`Erro ao salvar: ${error.message}`, 'error');
            return { success: false };
        }
    }
    
    // Salva um novo tipo de limite de crédito
    async function saveCreditLimitType(typeData) {
        try {
            const response = await fetch(`${API_BASE_URL}/creditLimit/saveTypeCreditLimit`, { 
                method: 'POST', 
                headers: { 
                    'Authorization': `Bearer ${BEARER_TOKEN}`, 
                    'Content-Type': 'application/json' 
                }, 
                body: JSON.stringify(typeData) 
            });
            
            if (!response.ok) {
                const errorBody = await response.json().catch(() => ({}));
                throw new Error(errorBody.message || `Erro na API: ${response.statusText}`);
            }
            const data = await response.json();
            updateCreditTypeDropdown(data);
            logChange('CRIOU TIPO DE LIMITE', 'N/A', { newType: data });
            return { success: true, data };
        } catch (error) {
            console.error('Falha ao salvar tipo:', error);
            showNotification(`Erro ao salvar tipo: ${error.message}`, 'error');
            return { success: false };
        }
    }

    // Desativa um limite de crédito (simula a exclusão)
    async function deleteCreditLimit(document, credit_type) {
        const limitToDelete = currentLimits.find(l => l.document === document && l.credit_type === credit_type);
        if (!limitToDelete) {
            showNotification('Limite não encontrado para desativar.', 'error');
            return;
        }
        
        // Define 'active' como false para desativar
        const updatedLimit = { ...limitToDelete, active: false }; 
        
        const result = await saveCreditLimit(updatedLimit);
        if (result.success) {
            showNotification('Limite desativado com sucesso!', 'success');
            logChange('DESATIVOU LIMITE', document, { type: credit_type });
            loadAndRenderLimits(foundCustomerDocument); // Recarrega os limites do cliente atual
        }
    }

    // --- FUNÇÕES DE RENDERIZAÇÃO E UI ---
    
    // Formata CNPJ/CPF
    function formatDocument(doc) {
        if (!doc) return '';
        const cleanDoc = doc.replace(/\D/g, '');
        if (cleanDoc.length === 11) return cleanDoc.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        if (cleanDoc.length === 14) return cleanDoc.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        return doc;
    }

    // Formata valor como moeda BRL
    function formatCurrency(value) {
        // Garante que o valor seja tratado como número
        const numericValue = Number(value) || 0; 
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(numericValue);
    }
    
    // Renderiza status booleano com badge
    function formatBoolean(value) {
        const text = value ? 'Sim' : 'Não';
        const color = value ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${color}">${text}</span>`;
    }

    // Formata data e hora
    function formatDateTime(isoString) {
        if (!isoString) return 'N/A';
        try {
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return 'N/A';
            return date.toLocaleString('pt-BR');
        } catch (e) {
            return 'Data inválida';
        }
    }

    // Renderiza as informações do cliente na tela
    function renderCustomerInfo(customer) {
        // A API retorna address como um array de endereços, mas a especificação exige exibir o principal.
        // O cliente fornecido no exemplo do Postman possui dois campos "address",
        // um contendo um array de endereços e outro o "registrationAddress". 
        // Vamos priorizar o primeiro endereço no array 'address' que é o principal (principal: true)
        // ou o objeto 'registrationAddress' que você usou no seu JSON de exemplo (simplificando para o primeiro endereço).
        const addressData = Array.isArray(customer.address) && customer.address.length > 0
            ? customer.address.find(addr => addr.principal) || customer.address[0]
            : customer.registrationAddress || {};
            
        const fullAddress = [
            addressData.street,
            addressData.number,
            addressData.complement ? `(${addressData.complement})` : ''
        ].filter(n => n).join(', ') + 
        (addressData.city ? `. ${addressData.city} - ${addressData.state}` : '') + 
        (addressData.zipcode ? ` (${addressData.zipcode})` : '');

        customerNameSpan.textContent = customer.name || 'N/A';
        customerDocumentSpan.textContent = formatDocument(customer.document) || 'N/A';
        customerEmailSpan.textContent = customer.email || 'N/A';
        customerPhoneSpan.textContent = customer.phone || 'N/A';
        customerContactNameSpan.textContent = customer.contactName || 'N/A';
        customerAddressSpan.textContent = fullAddress || 'N/A';
        
        // Esconde a mensagem inicial e mostra as informações do cliente
        initialStateMessage.classList.add('hidden');
        customerInfoSection.classList.remove('hidden');
    }

    // Renderiza a tabela de limites
    function renderTable(limits) {
        tableBody.innerHTML = '';
        currentLimits = limits; 

        // O colspan mudou para 7 após a remoção da coluna Documento
        if (!limits || limits.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">Cliente encontrado, mas não possui limites de crédito cadastrados.</td></tr>';
            return;
        }
        
        limits.forEach(limit => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            // Linha da tabela ajustada para 7 colunas (Documento removido)
            row.innerHTML = `
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500" data-label="Tipo">${limit.credit_type}</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500" data-label="Valor">${formatCurrency(limit.value)}</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500" data-label="Saldo">${formatCurrency(limit.balance)}</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500 text-center" data-label="Ativo">${formatBoolean(limit.active)}</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500 text-center" data-label="Sem Limite">${formatBoolean(limit.without_credit_limit)}</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500" data-label="Última Alteração">${formatDateTime(limit.last_updated || limit.date_created)}</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm font-medium text-center" data-label="Ações">
                    <button class="edit-btn text-indigo-600 hover:text-indigo-900" data-document="${limit.document}" data-type="${limit.credit_type}">Editar</button>
                    <!-- O botão de excluir na verdade aciona a desativação (active: false) -->
                    <button class="delete-btn text-red-600 hover:text-red-900 ml-4" data-document="${limit.document}" data-type="${limit.credit_type}">Excluir</button>
                </td>`;
            tableBody.appendChild(row);
        });
    }

    // Carrega e renderiza os limites (somente do cliente encontrado)
    async function loadAndRenderLimits(document = foundCustomerDocument) {
        if (!document) {
             renderTable([]); 
             return;
        }
        const result = await fetchCreditLimits(document);
        if (result.success) renderTable(result.data);
    }

    // --- LÓGICA DE BUSCA PRINCIPAL ---

    async function handleSearch() {
        const document = searchInput.value.trim();
        if (!document) {
            resetAppView();
            showNotification('Por favor, digite um documento (CPF/CNPJ).', 'error');
            return;
        }

        if (!validateDocumentInput(searchInput)) {
            showNotification('Documento inválido. Deve ter 11 ou 14 dígitos.', 'error');
            return;
        }

        resetAppView(); // Limpa a tela antes de começar
        
        // 1. Busca do Cliente
        const customerResult = await fetchCustomer(document);

        if (customerResult.success) {
            
            // CORREÇÃO: Usamos String() e || '' para garantir que .document é uma string,
            // evitando o erro "Cannot read properties of undefined (reading 'replace')"
            foundCustomerDocument = String(customerResult.data.document || '').replace(/\D/g, ''); 
            
            if (!foundCustomerDocument) {
                showNotification('Erro: O documento retornado pela API do cliente está ausente ou inválido.', 'error');
                resetAppView();
                return;
            }
            
            renderCustomerInfo(customerResult.data);
            toggleActionButtons(true); // Habilita botões
            
            // 2. Busca de Limites
            const limitsResult = await fetchCreditLimits(foundCustomerDocument);
            
            limitsTableTitle.classList.remove('hidden');
            limitsTableContainer.classList.remove('hidden');
            
            if (limitsResult.success) {
                renderTable(limitsResult.data);
            } else {
                // Se o cliente foi encontrado mas não tem limites (fetchCreditLimits pode falhar)
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">Cliente encontrado, mas não possui limites de crédito cadastrados.</td></tr>';
            }
        } else {
            // Cliente não encontrado ou erro
            // Exibe a mensagem de erro simplificada na tela
            initialStateMessage.innerHTML = `<p class="text-center text-xl text-red-600 font-semibold">${customerResult.error}</p>`;
            initialStateMessage.classList.remove('hidden');
            initialStateMessage.classList.remove('text-gray-500'); // Remove o estilo de texto normal
            toggleActionButtons(false); 
            foundCustomerDocument = null;
        }
    }
    
    // Altera openModal para pré-preencher o documento se um cliente já foi encontrado
    function openModal(data = null) {
        // Primeiro, reseta o formulário para um estado limpo e conhecido.
        creditLimitForm.reset();
        isEditingInput.value = '';
    
        // Configura o modal para o modo de adição por padrão.
        modalTitle.textContent = 'Adicionar Novo Limite';
        documentoInput.readOnly = false;
        documentoInput.classList.remove('bg-gray-200', 'text-gray-500');
        tipoSelect.disabled = false;
        tipoSelect.classList.remove('bg-gray-200', 'text-gray-500');
        
        // Se 'data' for fornecido, estamos no modo de edição.
        if (data) { 
            modalTitle.textContent = 'Editar Limite de Crédito';
            documentoInput.value = data.document;
            documentoInput.readOnly = true;
            documentoInput.classList.add('bg-gray-200', 'text-gray-500');
            
            // Adiciona o tipo ao select se ele não existir
            const typeExists = Array.from(tipoSelect.options).some(opt => opt.value === data.credit_type);
            if (!typeExists && data.credit_type) {
                const newOption = document.createElement('option');
                newOption.value = data.credit_type;
                newOption.textContent = data.credit_type;
                tipoSelect.appendChild(newOption);
            }

            tipoSelect.value = data.credit_type;
            tipoSelect.disabled = true; // Não permite alterar o tipo em edição
            tipoSelect.classList.add('bg-gray-200', 'text-gray-500'); 
    
            // Formata valores numéricos para exibição com vírgula (R$)
            const numericValue = Number(data.value) || 0;
            const numericBalance = Number(data.balance) || 0;
            valorInput.value = numericValue.toFixed(2).replace('.', ',');
            saldoInput.value = numericBalance.toFixed(2).replace('.', ',');
            
            document.getElementById('ativo').checked = data.active;
            document.getElementById('semLimite').checked = data.without_credit_limit;
            
            isEditingInput.value = JSON.stringify({ document: data.document, type: data.credit_type });
        } else if (foundCustomerDocument) {
             // Pré-preenche o campo de documento com o cliente encontrado, se estiver adicionando
             documentoInput.value = formatDocument(foundCustomerDocument);
             documentoInput.readOnly = true;
             documentoInput.classList.add('bg-gray-200', 'text-gray-500');
        } else {
             documentoInput.readOnly = false;
             documentoInput.classList.remove('bg-gray-200', 'text-gray-500');
        }
        
        updateSaveButtonState();
        formModal.classList.remove('hidden');
    }

    function closeModal() { formModal.classList.add('hidden'); }
    
    // --- FUNÇÕES AUXILIARES PARA RELATÓRIO ---
    
    // Preenche o dropdown de tipos de limite no modal de relatório
    function populateReportLimitTypes() {
        reportLimitTypeSelect.innerHTML = '<option value="" selected>Todos os Tipos</option>';
        const options = Array.from(tipoSelect.options);
        
        options.forEach(option => {
            if (option.value) {
                const newOption = document.createElement('option');
                newOption.value = option.value;
                newOption.textContent = option.textContent;
                reportLimitTypeSelect.appendChild(newOption);
            }
        });
    }

    function openReportModal() {
        reportForm.reset();
        reportResultDiv.classList.add('hidden');
        reportResultDiv.innerHTML = '';
        reportModal.classList.remove('hidden');
        populateReportLimitTypes(); // Garante que os tipos de limite estejam atualizados
    }

    function closeReportModal() {
        reportModal.classList.add('hidden');
    }

    // Gerencia a submissão do formulário de Relatório
    async function handleGenerateReport(e) {
        e.preventDefault();
        
        const startDateValue = startDateInput.value;
        const endDateValue = endDateInput.value;
        const selectedType = reportLimitTypeSelect.value;
        
        if (!startDateValue || !endDateValue) {
            showNotification('Por favor, selecione a data de início e de fim.', 'error');
            return;
        }
        
        // As datas devem ser tratadas com fuso horário para garantir a faixa correta
        const startDate = new Date(startDateValue + 'T00:00:00');
        const endDate = new Date(endDateValue + 'T23:59:59');

        if (endDate < startDate) {
            showNotification('A data final não pode ser anterior à data inicial.', 'error');
            return;
        }

        // Busca todos os limites para filtrar por data e tipo
        const allLimitsResult = await fetchCreditLimits(); 
        if (!allLimitsResult.success) {
            showNotification('Não foi possível buscar os dados para o relatório.', 'error');
            return;
        }
        
        allLimitsForReport = allLimitsResult.data;

        // Filtra os limites por data e tipo
        const filteredLimits = allLimitsForReport.filter(limit => {
            const updateDate = limit.last_updated || limit.date_created;
            if (!updateDate) return false;
            const lastUpdated = new Date(updateDate);
            
            const matchesDate = lastUpdated >= startDate && lastUpdated <= endDate;
            const matchesType = !selectedType || limit.credit_type === selectedType;

            return matchesDate && matchesType;
        });

        if (filteredLimits.length > 0) {
            renderReport(filteredLimits);
        } else {
            openReportConfirmationModal();
        }
    }
    
    // Renderiza a tabela de resultados do relatório
    function renderReport(data) {
        reportResultDiv.innerHTML = '';
        reportResultDiv.classList.remove('hidden');

        if (data.length === 0) {
            reportResultDiv.innerHTML = '<p class="text-center text-gray-500">Nenhum registro encontrado para o período selecionado.</p>';
            return;
        }
        
        // Ordena por data (última alteração ou criação)
        const sortedData = data.sort((a, b) => new Date(b.last_updated || b.date_created) - new Date(a.last_updated || a.date_created));

        let tableHTML = `
            <h3 class="text-lg font-bold mb-2">Relatório de Alterações</h3>
            <div class="max-h-64 overflow-y-auto border rounded-lg">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="p-2 text-left">Documento</th>
                            <th class="p-2 text-left">Tipo</th>
                            <th class="p-2 text-left">Valor (R$)</th>
                            <th class="p-2 text-left">Saldo (R$)</th>
                            <th class="p-2 text-center">Ativo</th>
                            <th class="p-2 text-center">Sem Limite</th>
                            <th class="p-2 text-left">Data Alteração</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        sortedData.forEach(limit => {
            tableHTML += `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-2 whitespace-nowrap">${formatDocument(limit.document)}</td>
                    <td class="p-2 whitespace-nowrap">${limit.credit_type}</td>
                    <td class="p-2 whitespace-nowrap">${formatCurrency(limit.value)}</td>
                    <td class="p-2 whitespace-nowrap">${formatCurrency(limit.balance)}</td>
                    <td class="p-2 text-center">${formatBoolean(limit.active)}</td>
                    <td class="p-2 text-center">${formatBoolean(limit.without_credit_limit)}</td>
                    <td class="p-2 whitespace-nowrap">${formatDateTime(limit.last_updated || limit.date_created)}</td>
                </tr>
            `;
        });

        tableHTML += `
                    </tbody>
                </table>
            </div>
            <button id="downloadCsvButton" class="mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition text-sm">Baixar CSV</button>
        `;

        reportResultDiv.innerHTML = tableHTML;
        
        document.getElementById('downloadCsvButton').addEventListener('click', () => downloadReportAsCSV(sortedData));
    }

    // Função para baixar o relatório como CSV
    function downloadReportAsCSV(data) {
        const headers = ['Documento', 'Tipo', 'Valor', 'Saldo', 'Ativo', 'Sem Limite Alem Saldo', 'Ultima Alteracao'];
        const csvRows = [headers.join(';')];

        data.forEach(limit => {
            // Usamos aspas simples para garantir que o número do documento seja tratado como texto no Excel/CSV
            const row = [
                `'${limit.document}'`, 
                limit.credit_type,
                // Garantimos que valores numéricos usem ponto como separador decimal para CSV padrão
                (Number(limit.value) || 0).toFixed(2).replace('.', ','), 
                (Number(limit.balance) || 0).toFixed(2).replace('.', ','),
                limit.active ? 'Sim' : 'Não',
                limit.without_credit_limit ? 'Sim' : 'Não',
                formatDateTime(limit.last_updated || limit.date_created)
            ];
            csvRows.push(row.join(';')); // Usamos ponto e vírgula como separador para CSV em pt-BR
        });

        const csvString = csvRows.join('\n');
        // Cria um Blob com o encoding UTF-8 (necessário para caracteres especiais)
        const blob = new Blob(["\uFEFF" + csvString], { type: 'text/csv;charset=utf-8;' }); 
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'relatorio_limites.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // Funções auxiliares para fechar os demais modais
    function openTypeModal() {
        creditTypeForm.reset();
        typeFormModal.classList.remove('hidden');
        updateSaveTypeButtonState();
    }
    function closeTypeModal() { typeFormModal.classList.add('hidden'); }
    function openDeleteModal(doc, type) {
        deletePayload = { doc, type };
        documentToDeleteSpan.textContent = formatDocument(doc);
        typeToDeleteSpan.textContent = type;
        deleteConfirmationModal.classList.remove('hidden');
    }
    function closeDeleteModal() { deleteConfirmationModal.classList.add('hidden'); }
    function openReportConfirmationModal() {
        reportConfirmationModal.classList.remove('hidden');
    }
    function closeReportConfirmationModal() {
        reportConfirmationModal.classList.add('hidden');
    }
    function showWarningModal(message) {
        warningMessage.textContent = message;
        warningModal.classList.remove('hidden');
    }
    function closeWarningModal() {
        warningModal.classList.add('hidden');
    }

    // Adiciona um novo tipo de crédito ao dropdown
    function updateCreditTypeDropdown(newType) {
        const newOption = document.createElement('option');
        newOption.value = newType.code;
        newOption.textContent = newType.name;
        tipoSelect.appendChild(newOption);
        // Não atualiza o dropdown de relatório aqui, ele é atualizado ao abrir a modal
    }

    // Exibe notificação temporária
    function showNotification(message, type = 'success') {
        notificationMessage.textContent = message;
        notification.className = 'fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg transition-opacity duration-300 opacity-0';
        notification.classList.add(type === 'error' ? 'bg-red-500' : 'bg-green-500');
        notification.classList.remove('hidden');
        setTimeout(() => notification.classList.remove('opacity-0'), 10);
        setTimeout(() => {
            notification.classList.add('opacity-0');
            setTimeout(() => notification.classList.add('hidden'), 300);
        }, 4000);
    }
    
    // --- FUNÇÕES DE VALIDAÇÃO E FORMATAÇÃO ---
    
    // Valida se o documento tem 11 (CPF) ou 14 (CNPJ) dígitos
    function validateDocumentInput(inputElement) {
        const value = inputElement.value.replace(/\D/g, '');
        if (value.length > 0 && value.length !== 11 && value.length !== 14) {
            inputElement.classList.add('border-red-500');
            return false;
        } else {
            inputElement.classList.remove('border-red-500');
            return true;
        }
    }

    // Valida se o código do tipo de limite não contém espaços
    function validateTypeCodeInput() {
        const hasSpace = /\s/.test(typeCodeInput.value);
        if (hasSpace) {
            typeCodeInput.classList.add('border-red-500');
            return false;
        } else {
            typeCodeInput.classList.remove('border-red-500');
            return true;
        }
    }
    
    // Formata o input de moeda em tempo real (ex: 12345 -> 123,45)
    function formatCurrencyInput(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value === '') {
            e.target.value = '';
            return;
        }
        // Converte para centavos e depois para float com 2 casas decimais
        value = (parseInt(value, 10) / 100).toFixed(2); 
        if (isNaN(value)) value = '0.00';
        // Exibe com vírgula como separador decimal
        e.target.value = value.replace('.', ','); 
    }

    // Habilita/desabilita o botão Salvar Limite com base na validação
    function updateSaveButtonState() {
        const isDocumentValid = validateDocumentInput(documentoInput) && documentoInput.value.length > 0;
        const isTypeSelected = tipoSelect.value !== "";
        // Verifica se o valor é preenchido e diferente de "0,00"
        const isValorValid = valorInput.value.trim() !== '' && valorInput.value.replace(',', '.').trim() !== '0.00'; 

        if (isDocumentValid && isTypeSelected && isValorValid) {
            saveLimitButton.disabled = false;
            saveLimitButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
            saveLimitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
        } else {
            saveLimitButton.disabled = true;
            saveLimitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            saveLimitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        }
    }

    // Habilita/desabilita o botão Salvar Tipo com base na validação
    function updateSaveTypeButtonState() {
        const isNameValid = typeNameInput.value.trim() !== '';
        const isCodeValid = typeCodeInput.value.trim() !== '' && !/\s/.test(typeCodeInput.value);

        if (isNameValid && isCodeValid) {
            saveTypeButton.disabled = false;
            saveTypeButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
            saveTypeButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
        } else {
            saveTypeButton.disabled = true;
            saveTypeButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            saveTypeButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        }
    }

    // --- MANIPULADORES DE EVENTOS ---
    
    // Login e Logout
    loginForm.addEventListener('submit', handleLogin);
    logoutButton.addEventListener('click', handleLogout);

    // Busca (Chamada ao novo fluxo handleSearch)
    searchButton.addEventListener('click', handleSearch);
    searchInput.addEventListener('keyup', (e) => {
        validateDocumentInput(searchInput);
        if (e.key === 'Enter') {
            handleSearch();
        } else if (e.key === 'Enter' && searchInput.value.trim() === '') {
            resetAppView();
        }
    });

    // Botões principais
    addLimitButton.addEventListener('click', () => openModal());
    addTypeButton.addEventListener('click', openTypeModal);
    extractReportButton.addEventListener('click', openReportModal);

    // Fechar Modais
    closeModalButton.addEventListener('click', closeModal);
    cancelButton.addEventListener('click', closeModal);
    closeTypeModalButton.addEventListener('click', closeTypeModal);
    cancelTypeButton.addEventListener('click', closeTypeModal);
    closeReportModalButton.addEventListener('click', closeReportModal);
    cancelReportButton.addEventListener('click', closeReportModal);
    cancelDeleteButton.addEventListener('click', closeDeleteModal);
    closeWarningModalButton.addEventListener('click', closeWarningModal);

    // Confirmação de Relatório Total
    cancelReportConfirmButton.addEventListener('click', closeReportConfirmationModal);
    confirmReportButton.addEventListener('click', () => {
        if (allLimitsForReport.length > 0) {
            renderReport(allLimitsForReport); // Renderiza todos os limites
        }
        closeReportConfirmationModal();
    });

    // Geração de Relatório
    reportForm.addEventListener('submit', handleGenerateReport);

    // Ações da Tabela (Editar/Excluir)
    tableBody.addEventListener('click', (e) => {
        const target = e.target;
        const doc = target.dataset.document;
        const type = target.dataset.type;
        if (target.classList.contains('edit-btn')) {
            const limitToEdit = currentLimits.find(l => l.document === doc && l.credit_type === type);
            if (limitToEdit) openModal(limitToEdit);
        }
        if (target.classList.contains('delete-btn')) {
            openDeleteModal(doc, type);
        }
    });

    // Confirmação de Exclusão
    confirmDeleteButton.addEventListener('click', () => {
        if (deletePayload) {
            deleteCreditLimit(deletePayload.doc, deletePayload.type);
            closeDeleteModal();
        }
    });
    
    // Eventos de input para formatação e validação de limite
    valorInput.addEventListener('input', formatCurrencyInput);
    valorInput.addEventListener('keyup', updateSaveButtonState);
    saldoInput.addEventListener('input', formatCurrencyInput);
    documentoInput.addEventListener('keyup', updateSaveButtonState);
    tipoSelect.addEventListener('change', updateSaveButtonState);
    
    // Eventos de input para validação de tipo de limite
    typeNameInput.addEventListener('keyup', updateSaveTypeButtonState);
    typeCodeInput.addEventListener('keyup', () => {
        validateTypeCodeInput();
        updateSaveTypeButtonState();
    });

    // Submissão do formulário de Limite
    creditLimitForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Verifica se o botão está desabilitado, impede submissão sem os campos obrigatórios
        if (saveLimitButton.disabled) return; 

        const isEditing = !!isEditingInput.value;
        const formData = new FormData(creditLimitForm);
        // Converte a vírgula para ponto antes de converter para float
        const value = parseFloat(formData.get('value').replace(',', '.')) || 0; 
        const balance = parseFloat(formData.get('balance').replace(',', '.')) || 0;

        if (value < 0 || balance < 0) {
            showNotification('Valores de limite e saldo não podem ser negativos.', 'error');
            return;
        }
        
        // CORREÇÃO: Garante que formData.get('document') seja uma string antes do replace
        const documentValue = String(formData.get('document') || '').replace(/\D/g, '');

        if (!documentValue) {
            showNotification('Erro: Documento inválido no formulário.', 'error');
            return;
        }

        let creditType;
        
        if (isEditing) {
            const originalData = JSON.parse(isEditingInput.value);
            creditType = originalData.type;
        } else {
            // Se for adição, verifica a existência do cliente (já verificada na busca, mas mantida a validação de segurança)
            if (!foundCustomerDocument || foundCustomerDocument !== documentValue) {
                // Se o cliente não foi buscado ou o documento foi alterado, faz a busca novamente
                const customerExists = await fetchCustomer(documentValue);
                if (!customerExists.success) {
                    showWarningModal(customerExists.error);
                    return;
                }
            }
            
            creditType = formData.get('credit_type');
            
            // Verifica duplicidade no front-end antes de enviar
            const alreadyExists = currentLimits.some(limit => limit.document === documentValue && limit.credit_type === creditType && limit.active);
            if (alreadyExists) {
                showWarningModal('Já existe um limite ATIVO cadastrado para este documento com o tipo selecionado.');
                return;
            }
        }

        const limitData = {
            document: documentValue,
            credit_type: creditType,
            value: value,
            balance: balance,
            active: formData.get('active') === 'on', // Checkbox value is 'on' if checked
            without_credit_limit: formData.get('without_credit_limit') === 'on'
        };

        const result = await saveCreditLimit(limitData);
        if (result.success) {
            closeModal();
            showNotification('Limite salvo com sucesso!', 'success');
            // Recarrega os limites do cliente atual para atualizar a tabela
            loadAndRenderLimits(documentValue); 
        }
    });

    // Submissão do formulário de Tipo de Limite
    creditTypeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (saveTypeButton.disabled) return;

        if (!validateTypeCodeInput()) {
            showNotification('Código do tipo não pode conter espaços.', 'error');
            return;
        }
        
        const formData = new FormData(creditTypeForm);
        const typeData = { name: formData.get('name'), code: formData.get('code') };
        
        // Verifica se o código de tipo já existe no dropdown (case insensitive)
        const existingType = Array.from(tipoSelect.options).some(option => option.value.toUpperCase() === typeData.code.toUpperCase());
        if (existingType) {
            showWarningModal('O código de tipo informado já existe. Por favor, utilize outro código.');
            return;
        }

        const result = await saveCreditLimitType(typeData);
        if (result.success) {
            closeTypeModal();
            showNotification(`Tipo "${result.data.name}" salvo com sucesso!`, 'success');
            populateReportLimitTypes(); // Atualiza o seletor de relatório
        }
    });


    // --- INICIALIZAÇÃO ---
    // Verifica sessão salva no localStorage e inicializa a aplicação
    function initializeApp() {
        const storedToken = localStorage.getItem('bearerToken');
        const storedEmail = localStorage.getItem('loggedInUserEmail');

        if (storedToken && storedEmail) {
            BEARER_TOKEN = storedToken;
            LOGGED_IN_USER_EMAIL = storedEmail;

            userEmailDisplay.textContent = storedEmail;
            loginScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            
            // O estado inicial agora é a tela de busca vazia
            resetAppView(); 
            populateReportLimitTypes(); // Garante o preenchimento inicial dos tipos no relatório
        }
    }
    
    initializeApp();
});
</script>

</body>
</html>
