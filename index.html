<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Limite de Crédito</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media screen and (max-width: 768px) { .responsive-table thead { display: none; } .responsive-table tr { display: block; margin-bottom: 1rem; border-bottom: 2px solid #ddd; } .responsive-table td { display: block; text-align: right; padding-left: 50%; position: relative; } .responsive-table td::before { content: attr(data-label); position: absolute; left: 0.5rem; width: 45%; padding-right: 0.5rem; text-align: left; font-weight: bold; } }
        .asterisk { color: #ef4444; }
        select:disabled { color: #6b7280; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="loginScreen" class="container mx-auto flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Login</h1>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required placeholder="seu@email.com">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition" required placeholder="********">
                </div>
                <button type="submit" id="loginButton" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 shadow-sm flex items-center justify-center">
                    <span id="loginButtonText">Entrar</span>
                    <svg id="loginSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <div id="app" class="container mx-auto p-4 md:p-8 hidden">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Limite de Crédito</h1>
                <p class="text-gray-500">Gerencie os limites de crédito dos clientes.</p>
            </div>
            <div id="userInfo" class="text-right">
                <p class="text-sm text-gray-700">Bem-vindo(a), <strong id="userEmailDisplay"></strong></p>
                <button id="logoutButton" class="text-sm text-red-600 hover:underline">Sair</button>
            </div>
        </header>

        <main class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div class="relative w-full md:w-1/3">
                    <input type="text" id="searchInput" placeholder="Buscar por Documento (CNPJ/CPF)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                    <button id="searchButton" class="absolute right-0 top-0 mt-3 mr-4 text-gray-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </button>
                </div>
                <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                    <button id="extractReportButton" class="w-full md:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition duration-300 shadow-sm">Extrair Relatório</button>
                    <button id="addTypeButton" class="w-full md:w-auto bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition duration-300 shadow-sm">+ Novo Tipo</button>
                    <button id="addLimitButton" class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 shadow-sm">+ Novo Limite</button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full bg-white responsive-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Documento</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor (R$)</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saldo (R$)</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ativo</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Sem Limite Além Saldo</th>
                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Última Alteração</th>
                            <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="creditLimitTableBody" class="divide-y divide-gray-200">
                         <tr><td colspan="8" class="text-center p-8 text-gray-500">Nenhum limite de crédito encontrado. Realize uma busca ou adicione um novo limite.</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="formModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4"><div class="flex justify-between items-center mb-6"><h2 id="modalTitle" class="text-2xl font-bold text-gray-800">Adicionar Novo Limite</h2><button id="closeModalButton" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><form id="creditLimitForm"><input type="hidden" id="isEditing" value=""><div class="mb-4"><label for="documento" class="block text-sm font-medium text-gray-700 mb-1">Documento (CNPJ/CPF) <span class="asterisk">*</span></label><input type="text" id="documento" name="document" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="(somente números)" required></div><div class="mb-4"><label for="tipo" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Limite <span class="asterisk">*</span></label><select id="tipo" name="credit_type" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" required><option value="" disabled selected>Selecione um tipo...</option><option value="AVISTA">AVISTA</option><option value="PRAZO_30D">PRAZO 30D</option><option value="PRAZO_60D">PRAZO 60D</option><option value="ESPECIAL">ESPECIAL</option></select></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label for="valor" class="block text-sm font-medium text-gray-700 mb-1">Valor do Limite (R$) <span class="asterisk">*</span></label><input type="text" id="valor" name="value" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="0,00"></div><div><label for="saldo" class="block text-sm font-medium text-gray-700 mb-1">Saldo Disponível (R$)</label><input type="text" id="saldo" name="balance" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0,00"></div></div><div class="flex items-center space-x-8 mb-6"><div class="flex items-center"><input type="checkbox" id="ativo" name="active" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="ativo" class="ml-2 block text-sm text-gray-900">Ativo</label></div><div class="flex items-center"><input type="checkbox" id="semLimite" name="without_credit_limit" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="semLimite" class="ml-2 block text-sm text-gray-900">Sem Limite Além do Saldo</label></div></div><div class="flex justify-end gap-4"><button type="button" id="cancelButton" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button><button type="submit" id="saveLimitButton" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition hover:bg-blue-700">Salvar</button></div></form></div></div>
    <div id="typeFormModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4"><div class="flex justify-between items-center mb-6"><h2 id="typeModalTitle" class="text-2xl font-bold text-gray-800">Adicionar Novo Tipo de Limite</h2><button id="closeTypeModalButton" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><form id="creditTypeForm"><div class="mb-4"><label for="typeName" class="block text-sm font-medium text-gray-700 mb-1">Nome do Tipo <span class="asterisk">*</span></label><input type="text" id="typeName" name="name" placeholder="Ex: PRAZO 90D" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></div><div class="mb-4"><label for="typeCode" class="block text-sm font-medium text-gray-700 mb-1">Código do Tipo <span class="asterisk">*</span></label><input type="text" id="typeCode" name="code" placeholder="Ex: PRAZO_90D (sem espaços)" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></div><div class="flex justify-end gap-4 mt-8"><button type="button" id="cancelTypeButton" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button><button type="submit" id="saveTypeButton" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition hover:bg-blue-700">Salvar Tipo</button></div></form></div></div>
    <div id="deleteConfirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4"><h2 class="text-2xl font-bold text-gray-800 mb-4">Confirmar Exclusão</h2><p class="text-gray-600 mb-6">Você tem certeza que deseja excluir o limite de crédito para o documento <strong id="documentToDelete" class="text-gray-900"></strong> - <strong id="typeToDelete" class="text-gray-900"></strong>.</p><div class="flex justify-end gap-4"><button id="cancelDeleteButton" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button><button id="confirmDeleteButton" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition">Confirmar Exclusão</button></div></div></div>
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-gray-800">Extrair Relatório de Limites</h2><button id="closeReportModalButton" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><form id="reportForm"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><div><label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Data de Início</label><input type="date" id="startDate" name="startDate" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></div><div><label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">Data de Fim</label><input type="date" id="endDate" name="endDate" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></div></div><div class="flex justify-end gap-4"><button type="button" id="cancelReportButton" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition">Cancelar</button><button type="submit" id="generateReportButton" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition">Gerar Relatório</button></div></form><div id="reportResult" class="mt-6 border-t pt-4 hidden"></div></div></div>
    <div id="notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg transition-opacity duration-300 opacity-0 hidden"><p id="notificationMessage"></p></div>
    <div id="warningModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4"><h2 class="text-2xl font-bold text-yellow-600 mb-4">Atenção</h2><p id="warningMessage" class="text-gray-600 mb-6"></p><div class="flex justify-end"><button id="closeWarningModalButton" class="bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-600 transition">Fechar</button></div></div></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 1. CONFIGURAÇÕES E SELEÇÃO DE ELEMENTOS DO DOM ---
    const API_BASE_URL = 'https://ws.sandbox.autorei.net';
    let BEARER_TOKEN = '';
    let LOGGED_IN_USER_EMAIL = '';
    let currentLimits = [];
    let deletePayload = null;

    // Elementos da Tela Principal
    const appScreen = document.getElementById('app');
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const tableBody = document.getElementById('creditLimitTableBody');
    const addLimitButton = document.getElementById('addLimitButton');
    const addTypeButton = document.getElementById('addTypeButton');
    const userEmailDisplay = document.getElementById('userEmailDisplay');
    const logoutButton = document.getElementById('logoutButton');
    const extractReportButton = document.getElementById('extractReportButton');
    
    // Elementos de Login
    const loginScreen = document.getElementById('loginScreen');
    const loginForm = document.getElementById('loginForm');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('loginButton');
    const loginButtonText = document.getElementById('loginButtonText');
    const loginSpinner = document.getElementById('loginSpinner');
    
    // Elementos dos Modais
    const formModal = document.getElementById('formModal');
    const modalTitle = document.getElementById('modalTitle');
    const closeModalButton = document.getElementById('closeModalButton');
    const cancelButton = document.getElementById('cancelButton');
    const creditLimitForm = document.getElementById('creditLimitForm');
    const saveLimitButton = document.getElementById('saveLimitButton');
    const isEditingInput = document.getElementById('isEditing');
    const documentoInput = document.getElementById('documento');
    const tipoSelect = document.getElementById('tipo');
    const valorInput = document.getElementById('valor');
    const saldoInput = document.getElementById('saldo');
    const typeFormModal = document.getElementById('typeFormModal');
    const closeTypeModalButton = document.getElementById('closeTypeModalButton');
    const cancelTypeButton = document.getElementById('cancelTypeButton');
    const creditTypeForm = document.getElementById('creditTypeForm');
    const typeNameInput = document.getElementById('typeName');
    const typeCodeInput = document.getElementById('typeCode');
    const saveTypeButton = document.getElementById('saveTypeButton');
    const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
    const documentToDeleteSpan = document.getElementById('documentToDelete');
    const typeToDeleteSpan = document.getElementById('typeToDelete');
    const cancelDeleteButton = document.getElementById('cancelDeleteButton');
    const confirmDeleteButton = document.getElementById('confirmDeleteButton');
    const reportModal = document.getElementById('reportModal');
    const closeReportModalButton = document.getElementById('closeReportModalButton');
    const cancelReportButton = document.getElementById('cancelReportButton');
    const reportForm = document.getElementById('reportForm');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const reportResultDiv = document.getElementById('reportResult');
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notificationMessage');
    const warningModal = document.getElementById('warningModal');
    const warningMessage = document.getElementById('warningMessage');
    const closeWarningModalButton = document.getElementById('closeWarningModalButton');

    // --- 2. DEFINIÇÃO DE TODAS AS FUNÇÕES ---

    function initialize() {
        const storedToken = localStorage.getItem('authToken');
        const storedEmail = localStorage.getItem('userEmail');
        if (storedToken && storedEmail) {
            BEARER_TOKEN = storedToken;
            LOGGED_IN_USER_EMAIL = storedEmail;
            showApp();
        }
    }

    function showApp() {
        userEmailDisplay.textContent = LOGGED_IN_USER_EMAIL;
        loginScreen.classList.add('hidden');
        appScreen.classList.remove('hidden');
        loadAndRenderLimits();
    }

    function showLoginSpinner(show) {
        loginButton.disabled = show;
        loginButtonText.classList.toggle('hidden', show);
        loginSpinner.classList.toggle('hidden', !show);
    }

    async function handleLogin(e) {
        e.preventDefault();
        showLoginSpinner(true);
        const email = emailInput.value;
        const password = passwordInput.value;
        const loginApiUrl = `${API_BASE_URL}/oauth/token`;
        const params = new URLSearchParams({ scope: 'trust', grant_type: 'password', username: email, password: password });
        try {
            const response = await fetch(loginApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Authorization': 'Basic YXBpLXdzOnBhc3N3b3JkLW1hc3Rlcg==' },
                body: params
            });
            if (!response.ok) throw new Error('Email ou senha inválidos.');
            const data = await response.json();
            BEARER_TOKEN = data.access_token;
            LOGGED_IN_USER_EMAIL = email;
            localStorage.setItem('authToken', BEARER_TOKEN);
            localStorage.setItem('userEmail', LOGGED_IN_USER_EMAIL);
            showApp();
        } catch (error) {
            showNotification(error.message, 'error');
        } finally {
            showLoginSpinner(false);
        }
    }

    function handleLogout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userEmail');
        window.location.reload();
    }

    async function fetchCreditLimits(document = '') {
        const url = new URL(`${API_BASE_URL}/creditLimit/list`);
        url.searchParams.append('limit', '25');
        if (document) url.searchParams.append('document', document.replace(/\D/g, ''));
        try {
            const response = await fetch(url, { headers: { 'Authorization': `Bearer ${BEARER_TOKEN}` } });
            if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
            return { success: true, data: await response.json() };
        } catch (error) {
            showNotification(`Erro ao buscar limites: ${error.message}`, 'error');
            return { success: false, data: [] };
        }
    }

    async function saveCreditLimit(limitData) {
        try {
            const response = await fetch(`${API_BASE_URL}/creditLimit/save`, { method: 'POST', headers: { 'Authorization': `Bearer ${BEARER_TOKEN}`, 'Content-Type': 'application/json' }, body: JSON.stringify(limitData) });
            if (!response.ok) throw new Error((await response.json()).message || 'Erro ao salvar limite.');
            return { success: true, data: await response.json() };
        } catch (error) {
            showNotification(`Erro: ${error.message}`, 'error');
            return { success: false };
        }
    }

    async function saveCreditLimitType(typeData) {
        try {
            const response = await fetch(`${API_BASE_URL}/creditLimit/saveTypeCreditLimit`, { method: 'POST', headers: { 'Authorization': `Bearer ${BEARER_TOKEN}`, 'Content-Type': 'application/json' }, body: JSON.stringify(typeData) });
            if (!response.ok) throw new Error((await response.json()).message || 'Erro ao salvar tipo.');
            const data = await response.json();
            updateCreditTypeDropdown(data);
            return { success: true, data };
        } catch (error) {
            showNotification(`Erro: ${error.message}`, 'error');
            return { success: false };
        }
    }

    async function deleteCreditLimit(document, credit_type) {
        const limitToDelete = currentLimits.find(l => l.document === document && l.credit_type === credit_type);
        if (!limitToDelete) return showNotification('Limite não encontrado para desativar.', 'error');
        const updatedLimit = { ...limitToDelete, active: false };
        const result = await saveCreditLimit(updatedLimit);
        if (result.success) {
            showNotification('Limite desativado com sucesso!', 'success');
            loadAndRenderLimits(searchInput.value);
        }
    }

    async function handleGenerateReport(e) {
        e.preventDefault();
        const startDate = new Date(startDateInput.value + 'T00:00:00');
        const endDate = new Date(endDateInput.value + 'T23:59:59');
        if (!startDateInput.value || !endDateInput.value || endDate < startDate) {
            return showNotification('Período de datas inválido.', 'error');
        }
        const allLimitsResult = await fetchCreditLimits();
        if (!allLimitsResult.success) return;
        const filteredLimits = allLimitsResult.data.filter(limit => {
            const updateDate = new Date(limit.last_updated || limit.date_created);
            return updateDate >= startDate && updateDate <= endDate;
        });
        renderReport(filteredLimits);
    }
    
    async function loadAndRenderLimits(document = '') {
        const result = await fetchCreditLimits(document);
        if (result.success) renderTable(result.data);
    }

    function renderTable(limits) {
        tableBody.innerHTML = '';
        if (!limits || limits.length === 0) {
            return tableBody.innerHTML = '<tr><td colspan="8" class="text-center p-8 text-gray-500">Nenhum limite encontrado.</td></tr>';
        }
        currentLimits = limits;
        const rows = limits.map(limit => `
            <tr class="hover:bg-gray-50">
                <td class="py-4 px-4" data-label="Documento">${formatDocument(limit.document)}</td>
                <td class="py-4 px-4" data-label="Tipo">${limit.credit_type}</td>
                <td class="py-4 px-4" data-label="Valor">${formatCurrency(limit.value)}</td>
                <td class="py-4 px-4" data-label="Saldo">${formatCurrency(limit.balance)}</td>
                <td class="py-4 px-4 text-center" data-label="Ativo">${formatBoolean(limit.active)}</td>
                <td class="py-4 px-4 text-center" data-label="Sem Limite">${formatBoolean(limit.without_credit_limit)}</td>
                <td class="py-4 px-4" data-label="Última Alteração">${formatDateTime(limit.last_updated || limit.date_created)}</td>
                <td class="py-4 px-4 text-center" data-label="Ações">
                    <button class="edit-btn text-indigo-600 hover:text-indigo-900" data-document="${limit.document}" data-type="${limit.credit_type}">Editar</button>
                    <button class="delete-btn text-red-600 hover:text-red-900 ml-4" data-document="${limit.document}" data-type="${limit.credit_type}">Excluir</button>
                </td>
            </tr>`).join('');
        tableBody.innerHTML = rows;
    }

    function renderReport(data) {
        reportResultDiv.classList.toggle('hidden', data.length === 0);
        if (data.length === 0) return reportResultDiv.innerHTML = '<p class="text-center text-gray-500">Nenhum registro encontrado.</p>';
        const tableRows = data.map(limit => `
            <tr class="border-b">
                <td class="p-2">${formatDocument(limit.document)}</td><td class="p-2">${limit.credit_type}</td>
                <td class="p-2">${formatCurrency(limit.value)}</td><td class="p-2">${formatCurrency(limit.balance)}</td>
                <td class="p-2 text-center">${formatBoolean(limit.active)}</td><td class="p-2">${formatDateTime(limit.last_updated || limit.date_created)}</td>
            </tr>`).join('');
        reportResultDiv.innerHTML = `<h3 class="text-lg font-bold mb-2">Relatório</h3><div class="max-h-64 overflow-y-auto"><table class="min-w-full text-sm"><thead class="bg-gray-100"><tr><th class="p-2 text-left">Documento</th><th class="p-2 text-left">Tipo</th><th class="p-2 text-left">Valor</th><th class="p-2 text-left">Saldo</th><th class="p-2 text-center">Ativo</th><th class="p-2 text-left">Data</th></tr></thead><tbody>${tableRows}</tbody></table></div><button id="downloadCsvButton" class="mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Baixar CSV</button>`;
        document.getElementById('downloadCsvButton').addEventListener('click', () => downloadReportAsCSV(data));
    }
    
    function downloadReportAsCSV(data) {
        const headers = ['Documento', 'Tipo', 'Valor', 'Saldo', 'Ativo', 'Sem Limite Alem Saldo', 'Ultima Alteracao'];
        const csvRows = [headers.join(',')];
        data.forEach(limit => csvRows.push([`'${limit.document}'`, limit.credit_type, limit.value, limit.balance, limit.active, limit.without_credit_limit, formatDateTime(limit.last_updated || limit.date_created)].join(',')));
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' }));
        link.setAttribute('download', 'relatorio_limites.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function openModal(data = null) {
        creditLimitForm.reset();
        isEditingInput.value = '';
        tipoSelect.value = "";
        const isEditing = data !== null;
        modalTitle.textContent = isEditing ? 'Editar Limite de Crédito' : 'Adicionar Novo Limite';
        documentoInput.readOnly = isEditing;
        documentoInput.classList.toggle('bg-gray-200', isEditing);
        tipoSelect.disabled = isEditing;
        tipoSelect.classList.toggle('bg-gray-200', isEditing);
        if (isEditing) {
            documentoInput.value = data.document;
            tipoSelect.value = data.credit_type;
            valorInput.value = (data.value || 0).toFixed(2).replace('.', ',');
            saldoInput.value = (data.balance || 0).toFixed(2).replace('.', ',');
            document.getElementById('ativo').checked = data.active;
            document.getElementById('semLimite').checked = data.without_credit_limit;
            isEditingInput.value = JSON.stringify({ document: data.document, type: data.credit_type });
        }
        formModal.classList.remove('hidden');
    }
    function closeModal() { formModal.classList.add('hidden'); }
    function openTypeModal() { creditTypeForm.reset(); typeFormModal.classList.remove('hidden'); }
    function closeTypeModal() { typeFormModal.classList.add('hidden'); }
    function openDeleteModal(doc, type) {
        deletePayload = { doc, type };
        documentToDeleteSpan.textContent = formatDocument(doc);
        typeToDeleteSpan.textContent = type;
        deleteConfirmationModal.classList.remove('hidden');
    }
    function closeDeleteModal() { deleteConfirmationModal.classList.add('hidden'); }
    function openReportModal() { reportForm.reset(); reportResultDiv.classList.add('hidden'); reportModal.classList.remove('hidden'); }
    function closeReportModal() { reportModal.classList.add('hidden'); }
    function updateCreditTypeDropdown(newType) {
        tipoSelect.appendChild(new Option(newType.name, newType.code));
    }
    function formatCurrencyInput(e) {
        let value = e.target.value.replace(/\D/g, '');
        e.target.value = value ? (parseInt(value, 10) / 100).toFixed(2).replace('.', ',') : '';
    }
    function formatDocument(doc) {
        if (!doc) return '';
        const cleanDoc = doc.replace(/\D/g, '');
        if (cleanDoc.length === 11) return cleanDoc.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        if (cleanDoc.length === 14) return cleanDoc.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        return doc;
    }
    function formatBoolean(value) {
        const text = value ? 'Sim' : 'Não';
        const color = value ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${color}">${text}</span>`;
    }
    function formatDateTime(isoString) {
        if (!isoString) return 'N/A';
        const date = new Date(isoString);
        return isNaN(date.getTime()) ? 'N/A' : date.toLocaleString('pt-BR');
    }
    function showNotification(message, type = 'success') {
        notificationMessage.textContent = message;
        notification.className = `fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg transition-opacity duration-300 opacity-0 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
        notification.classList.remove('hidden');
        setTimeout(() => notification.classList.remove('opacity-0'), 10);
        setTimeout(() => {
            notification.classList.add('opacity-0');
            setTimeout(() => notification.classList.add('hidden'), 300);
        }, 4000);
    }
    
    // --- 3. EVENT LISTENERS ---
    loginForm.addEventListener('submit', handleLogin);
    logoutButton.addEventListener('click', handleLogout);
    searchButton.addEventListener('click', () => loadAndRenderLimits(searchInput.value));
    searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') loadAndRenderLimits(searchInput.value); });
    addLimitButton.addEventListener('click', () => openModal());
    addTypeButton.addEventListener('click', openTypeModal);
    extractReportButton.addEventListener('click', openReportModal);
    closeModalButton.addEventListener('click', closeModal);
    cancelButton.addEventListener('click', closeModal);
    closeTypeModalButton.addEventListener('click', closeTypeModal);
    cancelTypeButton.addEventListener('click', closeTypeModal);
    closeDeleteModalButton.addEventListener('click', closeDeleteModal);
    cancelDeleteButton.addEventListener('click', closeDeleteModal);
    closeReportModalButton.addEventListener('click', closeReportModal);
    cancelReportButton.addEventListener('click', closeReportModal);
    closeWarningModalButton.addEventListener('click', () => warningModal.classList.add('hidden'));
    tableBody.addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        const { document, type } = target.dataset;
        if (target.classList.contains('edit-btn')) {
            const limitToEdit = currentLimits.find(l => l.document === document && l.credit_type === type);
            if (limitToEdit) openModal(limitToEdit);
        } else if (target.classList.contains('delete-btn')) {
            openDeleteModal(document, type);
        }
    });
    confirmDeleteButton.addEventListener('click', () => {
        if (deletePayload) {
            deleteCreditLimit(deletePayload.doc, deletePayload.type);
            closeDeleteModal();
        }
    });
    creditLimitForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(creditLimitForm);
        const limitData = {
            document: formData.get('document').replace(/\D/g, ''),
            credit_type: isEditingInput.value ? JSON.parse(isEditingInput.value).type : formData.get('credit_type'),
            value: parseFloat(String(formData.get('value')).replace(',', '.')) || 0,
            balance: parseFloat(String(formData.get('balance')).replace(',', '.')) || 0,
            active: formData.get('active') === 'on',
            without_credit_limit: formData.get('without_credit_limit') === 'on'
        };
        const result = await saveCreditLimit(limitData);
        if (result.success) {
            closeModal();
            showNotification('Limite salvo com sucesso!', 'success');
            loadAndRenderLimits(searchInput.value);
        }
    });
    creditTypeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const typeData = { name: typeNameInput.value, code: typeCodeInput.value };
        if (/\s/.test(typeData.code)) return showNotification('O código não pode conter espaços.', 'error');
        const result = await saveCreditLimitType(typeData);
        if (result.success) {
            closeTypeModal();
            showNotification(`Tipo "${result.data.name}" salvo com sucesso!`, 'success');
        }
    });
    reportForm.addEventListener('submit', handleGenerateReport);
    valorInput.addEventListener('input', formatCurrencyInput);
    saldoInput.addEventListener('input', formatCurrencyInput);

    // --- 4. INICIALIZAÇÃO DA APLICAÇÃO ---
    initialize();
});
</script>

</body>
</html>