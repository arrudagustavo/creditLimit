<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 1. CONFIGURAÇÕES E SELEÇÃO DE ELEMENTOS DO DOM ---
    const API_BASE_URL = 'https://ws.sandbox.autorei.net';
    let BEARER_TOKEN = '';
    let LOGGED_IN_USER_EMAIL = '';
    let currentLimits = [];
    let deletePayload = null;

    // ... (O restante das declarações de variáveis de elementos do DOM permanece o mesmo)
    const appScreen = document.getElementById('app');
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const tableBody = document.getElementById('creditLimitTableBody');
    const addLimitButton = document.getElementById('addLimitButton');
    const addTypeButton = document.getElementById('addTypeButton');
    const userEmailDisplay = document.getElementById('userEmailDisplay');
    const logoutButton = document.getElementById('logoutButton');
    const extractReportButton = document.getElementById('extractReportButton');
    const loginScreen = document.getElementById('loginScreen');
    const loginForm = document.getElementById('loginForm');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('loginButton');
    const loginButtonText = document.getElementById('loginButtonText');
    const loginSpinner = document.getElementById('loginSpinner');
    const formModal = document.getElementById('formModal');
    const modalTitle = document.getElementById('modalTitle');
    const closeModalButton = document.getElementById('closeModalButton');
    const cancelButton = document.getElementById('cancelButton');
    const creditLimitForm = document.getElementById('creditLimitForm');
    const saveLimitButton = document.getElementById('saveLimitButton');
    const isEditingInput = document.getElementById('isEditing');
    const documentoInput = document.getElementById('documento');
    const tipoSelect = document.getElementById('tipo');
    const valorInput = document.getElementById('valor');
    const saldoInput = document.getElementById('saldo');
    const typeFormModal = document.getElementById('typeFormModal');
    const closeTypeModalButton = document.getElementById('closeTypeModalButton');
    const cancelTypeButton = document.getElementById('cancelTypeButton');
    const creditTypeForm = document.getElementById('creditTypeForm');
    const typeNameInput = document.getElementById('typeName');
    const typeCodeInput = document.getElementById('typeCode');
    const saveTypeButton = document.getElementById('saveTypeButton');
    const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
    const documentToDeleteSpan = document.getElementById('documentToDelete');
    const typeToDeleteSpan = document.getElementById('typeToDelete');
    const cancelDeleteButton = document.getElementById('cancelDeleteButton');
    const confirmDeleteButton = document.getElementById('confirmDeleteButton');
    const reportModal = document.getElementById('reportModal');
    const closeReportModalButton = document.getElementById('closeReportModalButton');
    const cancelReportButton = document.getElementById('cancelReportButton');
    const reportForm = document.getElementById('reportForm');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const reportResultDiv = document.getElementById('reportResult');
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notificationMessage');
    const warningModal = document.getElementById('warningModal');
    const warningMessage = document.getElementById('warningMessage');
    const closeWarningModalButton = document.getElementById('closeWarningModalButton');

    // --- 2. DEFINIÇÃO DE TODAS AS FUNÇÕES ---

    function initialize() {
        console.log("Inicializando a aplicação...");
        const storedToken = localStorage.getItem('authToken');
        const storedEmail = localStorage.getItem('userEmail');
        
        // NOVO: Adicionando logs para depuração
        console.log("Token lido do localStorage:", storedToken);
        console.log("Email lido do localStorage:", storedEmail);

        if (storedToken && storedEmail) {
            console.log("Sessão encontrada. Exibindo a aplicação.");
            BEARER_TOKEN = storedToken;
            LOGGED_IN_USER_EMAIL = storedEmail;
            showApp();
        } else {
            console.log("Nenhuma sessão encontrada. Exibindo tela de login.");
            showLogin();
        }
    }

    function showApp() {
        userEmailDisplay.textContent = LOGGED_IN_USER_EMAIL;
        loginScreen.classList.add('hidden');
        appScreen.classList.remove('hidden');
        loadAndRenderLimits();
    }
    
    function showLogin() {
        appScreen.classList.add('hidden');
        loginScreen.classList.remove('hidden');
    }

    function showLoginSpinner(show) {
        loginButton.disabled = show;
        loginButtonText.classList.toggle('hidden', show);
        loginSpinner.classList.toggle('hidden', !show);
    }

    async function handleLogin(e) {
        e.preventDefault();
        showLoginSpinner(true);
        const email = emailInput.value;
        const password = passwordInput.value;
        const loginApiUrl = `${API_BASE_URL}/oauth/token`;
        const params = new URLSearchParams({ scope: 'trust', grant_type: 'password', username: email, password: password });
        try {
            const response = await fetch(loginApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Authorization': 'Basic YXBpLXdzOnBhc3N3b3JkLW1hc3Rlcg==' },
                body: params
            });
            if (!response.ok) throw new Error('Email ou senha inválidos.');
            const data = await response.json();
            BEARER_TOKEN = data.access_token;
            LOGGED_IN_USER_EMAIL = email;

            // NOVO: Adicionando logs para depuração
            console.log("Login bem-sucedido. Salvando no localStorage...");
            localStorage.setItem('authToken', BEARER_TOKEN);
            localStorage.setItem('userEmail', LOGGED_IN_USER_EMAIL);
            console.log("Token salvo:", localStorage.getItem('authToken'));

            showApp();
        } catch (error) {
            showNotification(error.message, 'error');
        } finally {
            showLoginSpinner(false);
        }
    }

    function handleLogout() {
        console.log("Executando logout.");
        localStorage.removeItem('authToken');
        localStorage.removeItem('userEmail');
        BEARER_TOKEN = '';
        LOGGED_IN_USER_EMAIL = '';
        showLogin();
    }

    async function fetchCreditLimits(document = '') {
        // NOVO: Adicionando log para depurar a chamada da API
        console.log(`Buscando limites com o token: Bearer ${BEARER_TOKEN}`);

        const url = new URL(`${API_BASE_URL}/creditLimit/list`);
        url.searchParams.append('limit', '25');
        if (document) url.searchParams.append('document', document.replace(/\D/g, ''));
        try {
            const response = await fetch(url, { headers: { 'Authorization': `Bearer ${BEARER_TOKEN}` } });
            if (!response.ok) {
                // Log específico para erro de autorização
                if(response.status === 401) {
                    console.error("Erro de autorização (401). O token pode ser inválido ou expirado.");
                    showNotification('Sua sessão expirou. Por favor, faça login novamente.', 'error');
                    handleLogout();
                }
                throw new Error(`Erro na API: ${response.statusText}`);
            }
            return { success: true, data: await response.json() };
        } catch (error) {
            if (error.message.includes('401')) return { success: false, data: [] };
            showNotification(`Erro ao buscar limites: ${error.message}`, 'error');
            return { success: false, data: [] };
        }
    }

    // ... (O restante de todas as outras funções permanece o mesmo)
    async function saveCreditLimit(limitData) {
        try {
            const response = await fetch(`${API_BASE_URL}/creditLimit/save`, { method: 'POST', headers: { 'Authorization': `Bearer ${BEARER_TOKEN}`, 'Content-Type': 'application/json' }, body: JSON.stringify(limitData) });
            if (!response.ok) throw new Error((await response.json()).message || 'Erro ao salvar limite.');
            return { success: true, data: await response.json() };
        } catch (error) {
            showNotification(`Erro: ${error.message}`, 'error');
            return { success: false };
        }
    }

    async function saveCreditLimitType(typeData) {
        try {
            const response = await fetch(`${API_BASE_URL}/creditLimit/saveTypeCreditLimit`, { method: 'POST', headers: { 'Authorization': `Bearer ${BEARER_TOKEN}`, 'Content-Type': 'application/json' }, body: JSON.stringify(typeData) });
            if (!response.ok) throw new Error((await response.json()).message || 'Erro ao salvar tipo.');
            const data = await response.json();
            updateCreditTypeDropdown(data);
            return { success: true, data };
        } catch (error) {
            showNotification(`Erro: ${error.message}`, 'error');
            return { success: false };
        }
    }

    async function deleteCreditLimit(document, credit_type) {
        const limitToDelete = currentLimits.find(l => l.document === document && l.credit_type === credit_type);
        if (!limitToDelete) return showNotification('Limite não encontrado para desativar.', 'error');
        const updatedLimit = { ...limitToDelete, active: false };
        const result = await saveCreditLimit(updatedLimit);
        if (result.success) {
            showNotification('Limite desativado com sucesso!', 'success');
            loadAndRenderLimits(searchInput.value);
        }
    }

    async function handleGenerateReport(e) {
        e.preventDefault();
        const startDate = new Date(startDateInput.value + 'T00:00:00');
        const endDate = new Date(endDateInput.value + 'T23:59:59');
        if (!startDateInput.value || !endDateInput.value || endDate < startDate) {
            return showNotification('Período de datas inválido.', 'error');
        }
        const allLimitsResult = await fetchCreditLimits();
        if (!allLimitsResult.success) return;
        const filteredLimits = allLimitsResult.data.filter(limit => {
            const updateDate = new Date(limit.last_updated || limit.date_created);
            return updateDate >= startDate && updateDate <= endDate;
        });
        renderReport(filteredLimits);
    }
    
    async function loadAndRenderLimits(document = '') {
        const result = await fetchCreditLimits(document);
        if (result.success) renderTable(result.data);
    }

    function renderTable(limits) {
        tableBody.innerHTML = '';
        if (!limits || limits.length === 0) {
            return tableBody.innerHTML = '<tr><td colspan="8" class="text-center p-8 text-gray-500">Nenhum limite encontrado.</td></tr>';
        }
        currentLimits = limits;
        const rows = limits.map(limit => `
            <tr class="hover:bg-gray-50">
                <td class="py-4 px-4" data-label="Documento">${formatDocument(limit.document)}</td>
                <td class="py-4 px-4" data-label="Tipo">${limit.credit_type}</td>
                <td class="py-4 px-4" data-label="Valor">${formatCurrency(limit.value)}</td>
                <td class="py-4 px-4" data-label="Saldo">${formatCurrency(limit.balance)}</td>
                <td class="py-4 px-4 text-center" data-label="Ativo">${formatBoolean(limit.active)}</td>
                <td class="py-4 px-4 text-center" data-label="Sem Limite">${formatBoolean(limit.without_credit_limit)}</td>
                <td class="py-4 px-4" data-label="Última Alteração">${formatDateTime(limit.last_updated || limit.date_created)}</td>
                <td class="py-4 px-4 text-center" data-label="Ações">
                    <button class="edit-btn text-indigo-600 hover:text-indigo-900" data-document="${limit.document}" data-type="${limit.credit_type}">Editar</button>
                    <button class="delete-btn text-red-600 hover:text-red-900 ml-4" data-document="${limit.document}" data-type="${limit.credit_type}">Excluir</button>
                </td>
            </tr>`).join('');
        tableBody.innerHTML = rows;
    }

    function renderReport(data) {
        reportResultDiv.classList.toggle('hidden', data.length === 0);
        if (data.length === 0) return reportResultDiv.innerHTML = '<p class="text-center text-gray-500">Nenhum registro encontrado.</p>';
        const tableRows = data.map(limit => `
            <tr class="border-b">
                <td class="p-2">${formatDocument(limit.document)}</td><td class="p-2">${limit.credit_type}</td>
                <td class="p-2">${formatCurrency(limit.value)}</td><td class="p-2">${formatCurrency(limit.balance)}</td>
                <td class="p-2 text-center">${formatBoolean(limit.active)}</td><td class="p-2">${formatDateTime(limit.last_updated || limit.date_created)}</td>
            </tr>`).join('');
        reportResultDiv.innerHTML = `<h3 class="text-lg font-bold mb-2">Relatório</h3><div class="max-h-64 overflow-y-auto"><table class="min-w-full text-sm"><thead class="bg-gray-100"><tr><th class="p-2 text-left">Documento</th><th class="p-2 text-left">Tipo</th><th class="p-2 text-left">Valor</th><th class="p-2 text-left">Saldo</th><th class="p-2 text-center">Ativo</th><th class="p-2 text-left">Data</th></tr></thead><tbody>${tableRows}</tbody></table></div><button id="downloadCsvButton" class="mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">Baixar CSV</button>`;
        document.getElementById('downloadCsvButton').addEventListener('click', () => downloadReportAsCSV(data));
    }
    
    function downloadReportAsCSV(data) {
        const headers = ['Documento', 'Tipo', 'Valor', 'Saldo', 'Ativo', 'Sem Limite Alem Saldo', 'Ultima Alteracao'];
        const csvRows = [headers.join(',')];
        data.forEach(limit => csvRows.push([`'${limit.document}'`, limit.credit_type, limit.value, limit.balance, limit.active, limit.without_credit_limit, formatDateTime(limit.last_updated || limit.date_created)].join(',')));
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' }));
        link.setAttribute('download', 'relatorio_limites.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function openModal(data = null) {
        creditLimitForm.reset();
        isEditingInput.value = '';
        tipoSelect.value = "";
        const isEditing = data !== null;
        modalTitle.textContent = isEditing ? 'Editar Limite de Crédito' : 'Adicionar Novo Limite';
        documentoInput.readOnly = isEditing;
        documentoInput.classList.toggle('bg-gray-200', isEditing);
        tipoSelect.disabled = isEditing;
        tipoSelect.classList.toggle('bg-gray-200', isEditing);
        if (isEditing) {
            documentoInput.value = data.document;
            tipoSelect.value = data.credit_type;
            valorInput.value = (data.value || 0).toFixed(2).replace('.', ',');
            saldoInput.value = (data.balance || 0).toFixed(2).replace('.', ',');
            document.getElementById('ativo').checked = data.active;
            document.getElementById('semLimite').checked = data.without_credit_limit;
            isEditingInput.value = JSON.stringify({ document: data.document, type: data.credit_type });
        }
        formModal.classList.remove('hidden');
    }
    function closeModal() { formModal.classList.add('hidden'); }
    function openTypeModal() { creditTypeForm.reset(); typeFormModal.classList.remove('hidden'); }
    function closeTypeModal() { typeFormModal.classList.add('hidden'); }
    function openDeleteModal(doc, type) {
        deletePayload = { doc, type };
        documentToDeleteSpan.textContent = formatDocument(doc);
        typeToDeleteSpan.textContent = type;
        deleteConfirmationModal.classList.remove('hidden');
    }
    function closeDeleteModal() { deleteConfirmationModal.classList.add('hidden'); }
    function openReportModal() { reportForm.reset(); reportResultDiv.classList.add('hidden'); reportModal.classList.remove('hidden'); }
    function closeReportModal() { reportModal.classList.add('hidden'); }
    function updateCreditTypeDropdown(newType) {
        tipoSelect.appendChild(new Option(newType.name, newType.code));
    }
    function formatCurrencyInput(e) {
        let value = e.target.value.replace(/\D/g, '');
        e.target.value = value ? (parseInt(value, 10) / 100).toFixed(2).replace('.', ',') : '';
    }
    function formatDocument(doc) {
        if (!doc) return '';
        const cleanDoc = doc.replace(/\D/g, '');
        if (cleanDoc.length === 11) return cleanDoc.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        if (cleanDoc.length === 14) return cleanDoc.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        return doc;
    }
    function formatBoolean(value) {
        const text = value ? 'Sim' : 'Não';
        const color = value ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${color}">${text}</span>`;
    }
    function formatDateTime(isoString) {
        if (!isoString) return 'N/A';
        const date = new Date(isoString);
        return isNaN(date.getTime()) ? 'N/A' : date.toLocaleString('pt-BR');
    }
    function showNotification(message, type = 'success') {
        notificationMessage.textContent = message;
        notification.className = `fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg transition-opacity duration-300 opacity-0 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
        notification.classList.remove('hidden');
        setTimeout(() => notification.classList.remove('opacity-0'), 10);
        setTimeout(() => {
            notification.classList.add('opacity-0');
            setTimeout(() => notification.classList.add('hidden'), 300);
        }, 4000);
    }
    
    // --- 3. EVENT LISTENERS ---
    loginForm.addEventListener('submit', handleLogin);
    logoutButton.addEventListener('click', handleLogout);
    searchButton.addEventListener('click', () => loadAndRenderLimits(searchInput.value));
    searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') loadAndRenderLimits(searchInput.value); });
    addLimitButton.addEventListener('click', () => openModal());
    addTypeButton.addEventListener('click', openTypeModal);
    extractReportButton.addEventListener('click', openReportModal);
    closeModalButton.addEventListener('click', closeModal);
    cancelButton.addEventListener('click', closeModal);
    closeTypeModalButton.addEventListener('click', closeTypeModal);
    cancelTypeButton.addEventListener('click', closeTypeModal);
    closeDeleteModalButton.addEventListener('click', closeDeleteModal);
    cancelDeleteButton.addEventListener('click', closeDeleteModal);
    closeReportModalButton.addEventListener('click', closeReportModal);
    cancelReportButton.addEventListener('click', closeReportModal);
    closeWarningModalButton.addEventListener('click', () => warningModal.classList.add('hidden'));
    tableBody.addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        const { document, type } = target.dataset;
        if (target.classList.contains('edit-btn')) {
            const limitToEdit = currentLimits.find(l => l.document === document && l.credit_type === type);
            if (limitToEdit) openModal(limitToEdit);
        } else if (target.classList.contains('delete-btn')) {
            openDeleteModal(document, type);
        }
    });
    confirmDeleteButton.addEventListener('click', () => {
        if (deletePayload) {
            deleteCreditLimit(deletePayload.doc, deletePayload.type);
            closeDeleteModal();
        }
    });
    creditLimitForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(creditLimitForm);
        const limitData = {
            document: formData.get('document').replace(/\D/g, ''),
            credit_type: isEditingInput.value ? JSON.parse(isEditingInput.value).type : formData.get('credit_type'),
            value: parseFloat(String(formData.get('value')).replace(',', '.')) || 0,
            balance: parseFloat(String(formData.get('balance')).replace(',', '.')) || 0,
            active: formData.get('active') === 'on',
            without_credit_limit: formData.get('without_credit_limit') === 'on'
        };
        const result = await saveCreditLimit(limitData);
        if (result.success) {
            closeModal();
            showNotification('Limite salvo com sucesso!', 'success');
            loadAndRenderLimits(searchInput.value);
        }
    });
    creditTypeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const typeData = { name: typeNameInput.value, code: typeCodeInput.value };
        if (/\s/.test(typeData.code)) return showNotification('O código não pode conter espaços.', 'error');
        const result = await saveCreditLimitType(typeData);
        if (result.success) {
            closeTypeModal();
            showNotification(`Tipo "${result.data.name}" salvo com sucesso!`, 'success');
        }
    });
    reportForm.addEventListener('submit', handleGenerateReport);
    valorInput.addEventListener('input', formatCurrencyInput);
    saldoInput.addEventListener('input', formatCurrencyInput);

    // --- 4. INICIALIZAÇÃO DA APLICAÇÃO ---
    initialize();
});
</script>