<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 1. CONFIGURAÇÕES E ELEMENTOS DO DOM ---
    // Variáveis Globais
    const API_BASE_URL = 'https://ws.sandbox.autorei.net';
    let BEARER_TOKEN = '';
    let LOGGED_IN_USER_EMAIL = '';
    let currentLimits = [];
    let deletePayload = null;

    // Elementos da Tela Principal
    const appScreen = document.getElementById('app');
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const tableBody = document.getElementById('creditLimitTableBody');
    const addLimitButton = document.getElementById('addLimitButton');
    const addTypeButton = document.getElementById('addTypeButton');
    const userEmailDisplay = document.getElementById('userEmailDisplay');
    const logoutButton = document.getElementById('logoutButton');
    const extractReportButton = document.getElementById('extractReportButton');
    
    // Elementos de Login
    const loginScreen = document.getElementById('loginScreen');
    const loginForm = document.getElementById('loginForm');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('loginButton');
    const loginButtonText = document.getElementById('loginButtonText');
    const loginSpinner = document.getElementById('loginSpinner');
    
    // Elementos dos Modais
    const formModal = document.getElementById('formModal');
    const modalTitle = document.getElementById('modalTitle');
    const closeModalButton = document.getElementById('closeModalButton');
    const cancelButton = document.getElementById('cancelButton');
    const creditLimitForm = document.getElementById('creditLimitForm');
    const saveLimitButton = document.getElementById('saveLimitButton');
    const isEditingInput = document.getElementById('isEditing');
    const documentoInput = document.getElementById('documento');
    const tipoSelect = document.getElementById('tipo');
    const valorInput = document.getElementById('valor');
    const saldoInput = document.getElementById('saldo');
    const typeFormModal = document.getElementById('typeFormModal');
    const closeTypeModalButton = document.getElementById('closeTypeModalButton');
    const cancelTypeButton = document.getElementById('cancelTypeButton');
    const creditTypeForm = document.getElementById('creditTypeForm');
    const typeNameInput = document.getElementById('typeName');
    const typeCodeInput = document.getElementById('typeCode');
    const saveTypeButton = document.getElementById('saveTypeButton');
    const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
    const documentToDeleteSpan = document.getElementById('documentToDelete');
    const typeToDeleteSpan = document.getElementById('typeToDelete');
    const cancelDeleteButton = document.getElementById('cancelDeleteButton');
    const confirmDeleteButton = document.getElementById('confirmDeleteButton');
    const reportModal = document.getElementById('reportModal');
    const closeReportModalButton = document.getElementById('closeReportModalButton');
    const cancelReportButton = document.getElementById('cancelReportButton');
    const reportForm = document.getElementById('reportForm');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const reportResultDiv = document.getElementById('reportResult');
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notificationMessage');
    const warningModal = document.getElementById('warningModal');
    const warningMessage = document.getElementById('warningMessage');
    const closeWarningModalButton = document.getElementById('closeWarningModalButton');

    // --- 2. DEFINIÇÃO DE TODAS AS FUNÇÕES ---
    
    // Funções de Inicialização e UI
    function initialize() {
        const storedToken = localStorage.getItem('authToken');
        const storedEmail = localStorage.getItem('userEmail');

        if (storedToken && storedEmail) {
            BEARER_TOKEN = storedToken;
            LOGGED_IN_USER_EMAIL = storedEmail;
            showApp();
        }
    }

    function showApp() {
        userEmailDisplay.textContent = LOGGED_IN_USER_EMAIL;
        loginScreen.classList.add('hidden');
        appScreen.classList.remove('hidden');
        loadAndRenderLimits();
    }

    function showLoginSpinner(show) {
        if (show) {
            loginButtonText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');
            loginButton.disabled = true;
        } else {
            loginButtonText.classList.remove('hidden');
            loginSpinner.classList.add('hidden');
            loginButton.disabled = false;
        }
    }
    
    // Funções de Login/Logout
    async function handleLogin(e) {
        e.preventDefault();
        showLoginSpinner(true);
        const email = emailInput.value;
        const password = passwordInput.value;
        const loginApiUrl = `${API_BASE_URL}/oauth/token`;
        const params = new URLSearchParams();
        params.append('scope', 'trust');
        params.append('grant_type', 'password');
        params.append('username', email);
        params.append('password', password);

        try {
            const response = await fetch(loginApiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': 'Basic YXBpLXdzOnBhc3N3b3JkLW1hc3Rlcg=='
                },
                body: params
            });
            if (!response.ok) throw new Error('Email ou senha inválidos.');
            
            const data = await response.json();
            BEARER_TOKEN = data.access_token;
            LOGGED_IN_USER_EMAIL = email;
            
            localStorage.setItem('authToken', BEARER_TOKEN);
            localStorage.setItem('userEmail', LOGGED_IN_USER_EMAIL);
            
            showApp();
        } catch (error) {
            console.error('Falha no login:', error);
            showNotification(error.message, 'error');
        } finally {
            showLoginSpinner(false);
        }
    }

    function handleLogout() {
        BEARER_TOKEN = '';
        LOGGED_IN_USER_EMAIL = '';
        emailInput.value = '';
        passwordInput.value = '';
        
        localStorage.removeItem('authToken');
        localStorage.removeItem('userEmail');
        
        appScreen.classList.add('hidden');
        loginScreen.classList.remove('hidden');
    }

    // Funções de API
    async function fetchCreditLimits(document = '') {
        const url = new URL(`${API_BASE_URL}/creditLimit/list`);
        url.searchParams.append('limit', '25');
        if (document) url.searchParams.append('document', document.replace(/\D/g, ''));

        try {
            const response = await fetch(url, { headers: { 'Authorization': `Bearer ${BEARER_TOKEN}`, 'Content-Type': 'application/json' } });
            if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
            const data = await response.json();
            return { success: true, data };
        } catch (error) {
            console.error('Falha ao buscar limites:', error);
            showNotification(`Erro ao buscar: ${error.message}`, 'error');
            return { success: false, data: [] };
        }
    }

    async function saveCreditLimit(limitData) {
        const isEditing = !!isEditingInput.value;
        try {
            const response = await fetch(`${API_BASE_URL}/creditLimit/save`, { method: 'POST', headers: { 'Authorization': `Bearer ${BEARER_TOKEN}`, 'Content-Type': 'application/json' }, body: JSON.stringify(limitData) });
            if (!response.ok) {
                 const errorBody = await response.json();
                 throw new Error(errorBody.message || `Erro na API: ${response.statusText}`);
            }
            const data = await response.json();
            return { success: true, data };
        } catch (error) {
            console.error('Falha ao salvar limite:', error);
            showNotification(`Erro ao salvar: ${error.message}`, 'error');
            return { success: false };
        }
    }
    
    async function saveCreditLimitType(typeData) {
        try {
            const response = await fetch(`${API_BASE_URL}/creditLimit/saveTypeCreditLimit`, { method: 'POST', headers: { 'Authorization': `Bearer ${BEARER_TOKEN}`, 'Content-Type': 'application/json' }, body: JSON.stringify(typeData) });
            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(errorBody.message || `Erro na API: ${response.statusText}`);
            }
            const data = await response.json();
            updateCreditTypeDropdown(data);
            return { success: true, data };
        } catch (error) {
            console.error('Falha ao salvar tipo:', error);
            showNotification(`Erro ao salvar tipo: ${error.message}`, 'error');
            return { success: false };
        }
    }

    async function deleteCreditLimit(document, credit_type) {
        const limitToDelete = currentLimits.find(l => l.document === document && l.credit_type === credit_type);
        if (!limitToDelete) {
            showNotification('Limite não encontrado para desativar.', 'error');
            return;
        }
        const updatedLimit = { ...limitToDelete, active: false };
        const result = await saveCreditLimit(updatedLimit);
        if (result.success) {
            showNotification('Limite desativado com sucesso!', 'success');
            loadAndRenderLimits(searchInput.value);
        }
    }

    // Funções de Renderização
    async function loadAndRenderLimits(document = '') {
        const result = await fetchCreditLimits(document);
        if (result.success) renderTable(result.data);
    }

    function renderTable(limits) {
        tableBody.innerHTML = '';
        if (!limits || limits.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center p-8 text-gray-500">Nenhum limite de crédito encontrado.</td></tr>';
            return;
        }
        currentLimits = limits;
        limits.forEach(limit => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
                <td class="py-4 px-4 whitespace-nowrap text-sm font-medium text-gray-900" data-label="Documento">${formatDocument(limit.document)}</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500" data-label="Tipo">${limit.credit_type}</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500" data-label="Valor">${formatCurrency(limit.value)}</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500" data-label="Saldo">${formatCurrency(limit.balance)}</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500 text-center" data-label="Ativo">${formatBoolean(limit.active)}</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500 text-center" data-label="Sem Limite">${formatBoolean(limit.without_credit_limit)}</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500" data-label="Última Alteração">${formatDateTime(limit.last_updated || limit.date_created)}</td>
                <td class="py-4 px-4 whitespace-nowrap text-sm font-medium text-center" data-label="Ações">
                    <button class="edit-btn text-indigo-600 hover:text-indigo-900" data-document="${limit.document}" data-type="${limit.credit_type}">Editar</button>
                    <button class="delete-btn text-red-600 hover:text-red-900 ml-4" data-document="${limit.document}" data-type="${limit.credit_type}">Excluir</button>
                </td>`;
            tableBody.appendChild(row);
        });
    }

    // Funções de Formatação e Utilidades
    function formatDocument(doc) {
        if (!doc) return '';
        const cleanDoc = doc.replace(/\D/g, '');
        if (cleanDoc.length === 11) return cleanDoc.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        if (cleanDoc.length === 14) return cleanDoc.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        return doc;
    }
    function formatCurrency(value) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value); }
    function formatBoolean(value) {
        const text = value ? 'Sim' : 'Não';
        const color = value ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${color}">${text}</span>`;
    }
    function formatDateTime(isoString) {
        if (!isoString) return 'N/A';
        try {
            const date = new Date(isoString);
            return isNaN(date.getTime()) ? 'N/A' : date.toLocaleString('pt-BR');
        } catch (e) { return 'Data inválida'; }
    }
    function showNotification(message, type = 'success') {
        notificationMessage.textContent = message;
        notification.className = 'fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg transition-opacity duration-300 opacity-0';
        notification.classList.add(type === 'error' ? 'bg-red-500' : 'bg-green-500');
        notification.classList.remove('hidden');
        setTimeout(() => notification.classList.remove('opacity-0'), 10);
        setTimeout(() => {
            notification.classList.add('opacity-0');
            setTimeout(() => notification.classList.add('hidden'), 300);
        }, 4000);
    }
    
    // Funções de manipulação de Modais
    function openModal(data = null) {
        creditLimitForm.reset();
        isEditingInput.value = '';
        tipoSelect.value = ""; 
        if (data) { 
            modalTitle.textContent = 'Editar Limite de Crédito';
            documentoInput.value = data.document;
            documentoInput.readOnly = true;
            documentoInput.classList.add('bg-gray-200', 'text-gray-500');
            tipoSelect.value = data.credit_type;
            tipoSelect.disabled = true;
            tipoSelect.classList.add('bg-gray-200', 'text-gray-500'); 
            valorInput.value = (data.value || 0).toFixed(2).replace('.', ',');
            saldoInput.value = (parseFloat(data.balance) || 0).toFixed(2).replace('.', ',');
            document.getElementById('ativo').checked = data.active;
            document.getElementById('semLimite').checked = data.without_credit_limit;
            isEditingInput.value = JSON.stringify({ document: data.document, type: data.credit_type });
        } else { 
            modalTitle.textContent = 'Adicionar Novo Limite';
            documentoInput.readOnly = false;
            documentoInput.classList.remove('bg-gray-200', 'text-gray-500');
            tipoSelect.disabled = false;
            tipoSelect.classList.remove('bg-gray-200', 'text-gray-500'); 
        }
        updateSaveButtonState();
        formModal.classList.remove('hidden');
    }
    function closeModal() { formModal.classList.add('hidden'); }
    function openTypeModal() {
        creditTypeForm.reset();
        typeFormModal.classList.remove('hidden');
        updateSaveTypeButtonState();
    }
    function closeTypeModal() { typeFormModal.classList.add('hidden'); }
    function openDeleteModal(doc, type) {
        deletePayload = { doc, type };
        documentToDeleteSpan.textContent = formatDocument(doc);
        typeToDeleteSpan.textContent = type;
        deleteConfirmationModal.classList.remove('hidden');
    }
    function closeDeleteModal() { deleteConfirmationModal.classList.add('hidden'); }
    
    // Funções de Validação de Formulários
    function updateSaveButtonState() {
        const isDocumentValid = documentoInput.value.length > 0;
        const isTypeSelected = tipoSelect.value !== "";
        const isValorValid = valorInput.value.trim() !== '' && valorInput.value.trim() !== '0,00';
        saveLimitButton.disabled = !(isDocumentValid && isTypeSelected && isValorValid);
        saveLimitButton.classList.toggle('bg-gray-400', saveLimitButton.disabled);
        saveLimitButton.classList.toggle('cursor-not-allowed', saveLimitButton.disabled);
        saveLimitButton.classList.toggle('bg-blue-600', !saveLimitButton.disabled);
        saveLimitButton.classList.toggle('hover:bg-blue-700', !saveLimitButton.disabled);
    }

    // --- 3. EVENT LISTENERS ---
    loginForm.addEventListener('submit', handleLogin);
    logoutButton.addEventListener('click', handleLogout);
    searchButton.addEventListener('click', () => loadAndRenderLimits(searchInput.value));
    searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') loadAndRenderLimits(searchInput.value); });
    addLimitButton.addEventListener('click', () => openModal());
    addTypeButton.addEventListener('click', openTypeModal);
    closeModalButton.addEventListener('click', closeModal);
    cancelButton.addEventListener('click', closeModal);
    closeTypeModalButton.addEventListener('click', closeTypeModal);
    cancelTypeButton.addEventListener('click', closeTypeModal);
    cancelDeleteButton.addEventListener('click', closeDeleteModal);
    tableBody.addEventListener('click', (e) => {
        const target = e.target;
        const doc = target.dataset.document;
        const type = target.dataset.type;
        if (target.classList.contains('edit-btn')) {
            const limitToEdit = currentLimits.find(l => l.document === doc && l.credit_type === type);
            if (limitToEdit) openModal(limitToEdit);
        }
        if (target.classList.contains('delete-btn')) openDeleteModal(doc, type);
    });
    confirmDeleteButton.addEventListener('click', () => {
        if (deletePayload) {
            deleteCreditLimit(deletePayload.doc, deletePayload.type);
            closeDeleteModal();
        }
    });
    creditLimitForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(creditLimitForm);
        const limitData = {
            document: formData.get('document').replace(/\D/g, ''),
            credit_type: isEditingInput.value ? JSON.parse(isEditingInput.value).type : formData.get('credit_type'),
            value: parseFloat(formData.get('value').replace(',', '.')) || 0,
            balance: parseFloat(formData.get('balance').replace(',', '.')) || 0,
            active: formData.get('active') === 'on',
            without_credit_limit: formData.get('without_credit_limit') === 'on'
        };
        const result = await saveCreditLimit(limitData);
        if (result.success) {
            closeModal();
            showNotification('Limite salvo com sucesso!', 'success');
            loadAndRenderLimits(searchInput.value);
        }
    });
    ['keyup', 'change'].forEach(evt => {
        creditLimitForm.addEventListener(evt, updateSaveButtonState);
    });

    // --- 4. INICIALIZAÇÃO DA APLICAÇÃO ---
    initialize();
});
</script>